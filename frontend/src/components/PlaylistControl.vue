<template>
  <div class="p-4 bg-gradient-to-r from-blue-900 to-black-600 rounded-lg">
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="mb-0">
      <span class="text-white text-sm font-medium">ğŸ¶è‡ªé¸æ··å’Œæ›²é¢¨èˆ‡æ•¸é‡</span>
    </div>
    
    <!-- æ§åˆ¶å€åŸŸ - ç¢ºä¿æ‰€æœ‰å…ƒç´ é«˜åº¦ä¸€è‡´ -->
    <div class="flex items-end space-x-4 flex-wrap">
      <!-- ç¬¬ä¸€å€‹æ›²é¢¨æŒ‰éˆ•çµ„ -->
      <div class="flex items-center space-x-2">
        <!-- æ›²é¢¨ä¸‹æ‹‰æŒ‰éˆ• -->
        <div class="relative">
          <button 
            @click="toggleGenreDropdown(0)" 
            class="genre-selector-btn px-6 py-3 bg-blue-100 text-blue rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[0].genre }}</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <!-- æµ®å‹•å¼æ›²é¢¨ä¸‹æ‹‰é¸å–® -->
          <div v-if="genreDropdownOpen[0]" class="floating-dropdown">
            <div 
              v-for="genre in availableGenres" 
              :key="genre.value" 
              @click="selectGenre(0, genre)" 
              class="dropdown-item"
            >
              {{ genre.label }}
            </div>
          </div>
        </div>

        <!-- æ•¸é‡ä¸‹æ‹‰æŒ‰éˆ• -->
        <div class="relative">
          <button 
            @click="toggleCountDropdown(0)" 
            class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[0].count }}é¦–</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <!-- æµ®å‹•å¼æ•¸å­—ä¸‹æ‹‰é¸å–® -->
          <div v-if="countDropdownOpen[0]" class="floating-dropdown">
            <div 
              v-for="count in [1, 2, 3, 4, 5]" 
              :key="count" 
              @click="selectCount(0, count)" 
              class="dropdown-item"
            >
              {{ count }}é¦–æ­Œæ›²
            </div>
          </div>
        </div>
      </div>

      <!-- åŠ è™Ÿ -->
      <div class="text-white text-2xl font-bold">+</div>

      <!-- ç¬¬äºŒå€‹æ›²é¢¨æŒ‰éˆ•çµ„ -->
      <div class="flex items-center space-x-2">
        <div class="relative">
          <button 
            @click="toggleGenreDropdown(1)" 
            class="genre-selector-btn px-6 py-3 bg-blue-100 text-black rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[1].genre }}</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <div v-if="genreDropdownOpen[1]" class="floating-dropdown">
            <div 
              v-for="genre in availableGenres" 
              :key="genre.value" 
              @click="selectGenre(1, genre)" 
              class="dropdown-item"
            >
              {{ genre.label }}
            </div>
          </div>
        </div>
        <div class="relative">
          <button 
            @click="toggleCountDropdown(1)" 
            class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[1].count }}é¦–</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <div v-if="countDropdownOpen[1]" class="floating-dropdown">
            <div 
              v-for="count in [1, 2, 3, 4, 5]" 
              :key="count" 
              @click="selectCount(1, count)" 
              class="dropdown-item"
            >
              {{ count }}é¦–æ­Œæ›²
            </div>
          </div>
        </div>
      </div>

      <!-- åŠ è™Ÿ -->
      <div class="text-white text-2xl font-bold">+</div>

      <!-- ç¬¬ä¸‰å€‹æ›²é¢¨æŒ‰éˆ•çµ„ -->
      <div class="flex items-center space-x-2">
        <div class="relative">
          <button 
            @click="toggleGenreDropdown(2)" 
            class="genre-selector-btn px-6 py-3 bg-blue-100 text-black rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[2].genre }}</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <div v-if="genreDropdownOpen[2]" class="floating-dropdown">
            <div 
              v-for="genre in availableGenres" 
              :key="genre.value" 
              @click="selectGenre(2, genre)" 
              class="dropdown-item"
            >
              {{ genre.label }}
            </div>
          </div>
        </div>
        <div class="relative">
          <button 
            @click="toggleCountDropdown(2)" 
            class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer"
          >
            <span>{{ playlistConfig[2].count }}é¦–</span>
            <font-awesome-icon icon="chevron-down" class="text-sm" />
          </button>
          <div v-if="countDropdownOpen[2]" class="floating-dropdown">
            <div 
              v-for="count in [1, 2, 3, 4, 5]" 
              :key="count" 
              @click="selectCount(2, count)" 
              class="dropdown-item"
            >
              {{ count }}é¦–æ­Œæ›²
            </div>
          </div>
        </div>
      </div>

      <!-- æ’­æ”¾æŒ‰éˆ• -->
      <button 
        @click="$emit('start-custom-playlist')" 
        :disabled="isGeneratingPlaylist"
        class="play-playlist-btn px-6 py-3 bg-orange-400 text-black hover:bg-gray-700 rounded-lg font-bold hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2 cursor-pointer"
      >
        <font-awesome-icon v-if="isGeneratingPlaylist" icon="spinner" class="animate-spin" />
        <font-awesome-icon v-else icon="play" />
        <span v-if="isGeneratingPlaylist">ç”Ÿæˆä¸­...</span>
        <span v-else>æ’­æ”¾</span>
      </button>

      <!-- ğŸ”§ ä¿®æ”¹ï¼šå›ºå®šé«˜åº¦çš„ç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
      <div class="status-container">
        <div 
          v-if="customPlaylistStatus.isActive && currentMode === 'custom'" 
          class="custom-playlist-status bg-blue-900/50 px-4 py-2 rounded-lg"
        >
          <div class="text-xs text-blue-200 mb-1">æ··å’Œæ›²é¢¨æ’­æ”¾æ¸…å–®</div>
          <div class="text-sm font-medium text-white">
            ç¬¬{{ customPlaylistStatus.currentGroup }}çµ„ {{ customPlaylistStatus.currentGenre }} 
            ({{ customPlaylistStatus.currentInGroup }}/{{ customPlaylistStatus.totalInGroup }})
          </div>
          <div class="text-xs text-blue-300 mt-1">
            ç¸½é€²åº¦: {{ customPlaylistStatus.overallProgress }}/{{ customPlaylistStatus.totalTracks }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  playlistConfig: {
    type: Array,
    required: true
  },
  isGeneratingPlaylist: {
    type: Boolean,
    required: true
  },
  customPlaylistStatus: {
    type: Object,
    required: true
  },
  currentMode: {
    type: String,
    required: true
  }
})

defineEmits(['start-custom-playlist'])

const genreDropdownOpen = ref([false, false, false])
const countDropdownOpen = ref([false, false, false])

// å¯ç”¨çš„æ›²é¢¨é¸é …
const availableGenres = [
  { label: 'Pop', value: 'pop' },
  { label: 'Rock', value: 'rock' },
  { label: 'Hip Hop', value: 'hiphop' },
  { label: 'Electronic', value: 'electronic' },
  { label: 'Jazz', value: 'jazz' },
  { label: 'Classical', value: 'classical' },
  { label: 'Metal', value: 'metal' },
  { label: 'Lounge', value: 'lounge' },
  { label: 'Soundtrack', value: 'soundtrack' },
  { label: 'World', value: 'world' }
]

const toggleGenreDropdown = (index) => {
  // é—œé–‰å…¶ä»–ä¸‹æ‹‰é¸å–®
  genreDropdownOpen.value = genreDropdownOpen.value.map((_, i) => i === index ? !genreDropdownOpen.value[i] : false)
  countDropdownOpen.value = countDropdownOpen.value.map(() => false)
}

const toggleCountDropdown = (index) => {
  // é—œé–‰å…¶ä»–ä¸‹æ‹‰é¸å–®
  countDropdownOpen.value = countDropdownOpen.value.map((_, i) => i === index ? !countDropdownOpen.value[i] : false)
  genreDropdownOpen.value = genreDropdownOpen.value.map(() => false)
}

const selectGenre = (index, genre) => {
  props.playlistConfig[index].genre = genre.label
  genreDropdownOpen.value[index] = false
  console.log(`é¸æ“‡æ›²é¢¨ ${index + 1}: ${genre.label}`)
}

const selectCount = (index, count) => {
  props.playlistConfig[index].count = count
  countDropdownOpen.value[index] = false
  console.log(`é¸æ“‡æ•¸é‡ ${index + 1}: ${count}`)
}

// é»æ“Šé é¢å…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®
const closeAllDropdowns = () => {
  genreDropdownOpen.value = [false, false, false]
  countDropdownOpen.value = [false, false, false]
}

const handleDocumentClick = (event) => {
  const target = event.target
  const isDropdownButton = target.closest('.genre-selector-btn') || target.closest('.count-selector-btn')
  
  if (!isDropdownButton) {
    closeAllDropdowns()
  }
}

onMounted(() => {
  document.addEventListener('click', handleDocumentClick)
})

onUnmounted(() => {
  document.removeEventListener('click', handleDocumentClick)
})
</script>

<style scoped>
/* ğŸ”§ æ–°å¢ï¼šå›ºå®šé«˜åº¦çš„ç‹€æ…‹å®¹å™¨ */
.status-container {
  min-width: 160px;
  min-height: 68px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œç¢ºä¿ç©ºé–“é ç•™ */
  display: flex;
  align-items: center;
}

/* æµ®å‹•å¼ä¸‹æ‹‰é¸å–®æ¨£å¼ */
.floating-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: rgba(237, 244, 176, 0.542);
  border: 1px solid #1f4288;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(14, 14, 14, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  z-index: 9999;
  min-width: 120px;
  max-height: 200px;
  overflow-y: auto;
  backdrop-filter: blur(8px);
  animation: dropdownFadeIn 0.15s ease-out;
}

/* ä¸‹æ‹‰å…§çš„æ–‡å­— */
.dropdown-item {
  padding: 8px 16px;
  cursor: pointer;
  color: #000000;
  font-weight: 500;
  transition: all 0.15s ease;
  border-bottom: 1px solid #f3f4f6;
}

.dropdown-item:hover {
  background-color: #f3f4f6;
  color: #1f2937;
}

.dropdown-item:first-child {
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
}

.dropdown-item:last-child {
  border-bottom-left-radius: 7px;
  border-bottom-right-radius: 7px;
  border-bottom: none;
}

/* ä¸‹æ‹‰é¸å–®å‹•ç•« */
@keyframes dropdownFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* æ··å’Œæ›²é¢¨æ’­æ”¾æ¸…å–® */
.custom-playlist-status {
  min-width: 160px;
  max-width: 200px;
  border: 1px solid rgba(255, 252, 252, 0.3);
  backdrop-filter: blur(5px);
}

.custom-playlist-status:hover {
  background: rgba(50, 65, 106, 0.6);
  border-color: rgba(255, 255, 254, 0.5);
}

/* ç¢ºä¿ç›¸å°å®šä½å®¹å™¨æ­£ç¢ºè¨­ç½® */
.relative {
  position: relative;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
  .status-container {
    min-height: 60px;
  }
  
  .custom-playlist-status {
    min-width: 150px;
    max-width: 200px;
  }
  
  .custom-playlist-status .text-sm {
    font-size: 0.75rem;
  }
  
  .custom-playlist-status .text-xs {
    font-size: 0.7rem;
  }
  
  .floating-dropdown {
    min-width: 100px;
    max-height: 150px;
  }
  
  .dropdown-item {
    padding: 6px 12px;
    font-size: 0.875rem;
  }
}

@media (max-width: 768px) {
  .status-container {
    min-height: 55px;
  }
  
  /* æ··å’Œæ›²é¢¨æ’­æ”¾æ¸…å–®åœ¨å°å±å¹•ä¸Šçš„éŸ¿æ‡‰å¼èª¿æ•´ */
  .flex-wrap {
    flex-wrap: wrap;
  }
  
  .space-x-4 > * + * {
    margin-left: 0.5rem;
  }
  
  .gap-4 {
    gap: 0.5rem;
  }
}
</style>