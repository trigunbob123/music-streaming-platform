<template>
  <div class="flex h-screen bg-gray-100">
    <!-- Â∑¶ÂÅ¥ÈÇäÊ¨Ñ -->
    <div class="w-64 sidebar text-white p-10">
      <div class="flex items-center justify-between mb-8">
        <!-- Âè™È°ØÁ§∫ logoÔºåÁßªÈô§ÈÄ£Êé•ÁãÄÊÖã -->
        <div class="flex items-center">
          <img src="@/assets/images/12.png" alt="DDM360" class="h-auto w-25" />
        </div>
        <!-- ÈÄ£Êé•ÊåâÈàïÂçÄÂüü -->
        <div class="flex space-x-2">
          <button v-if="!isJamendoConnected && jamendoConfigured" @click="connectJamendo" 
                  class="text-orange-400 hover:text-orange-300 text-sm">
            <font-awesome-icon icon="music" class="mr-1" />
            ÈÄ£Êé• Jamendo
          </button>
          <span v-else-if="!jamendoConfigured" class="text-gray-400 text-xs">
            Jamendo Êú™ÈÖçÁΩÆ
          </span>
        </div>
      </div>

      <nav class="space-y-4 mb-8">
        <button @click="setCurrentMode('random')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700 transition-colors"
                :class="{ 'bg-gray-700': currentMode === 'random' }">
          <font-awesome-icon icon="random" class="mr-3" />
          Èö®Ê©üÊí≠Êîæ
        </button>
        <button @click="setCurrentMode('latest')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700 transition-colors"
                :class="{ 'bg-gray-700': currentMode === 'latest' }">
          <font-awesome-icon icon="music" class="mr-3" />
          ÊúÄÊñ∞Èü≥Ê®Ç
        </button>
        <button @click="setCurrentMode('popular')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700 transition-colors"
                :class="{ 'bg-gray-700': currentMode === 'popular' }">
          <font-awesome-icon icon="fire" class="mr-3" />
          ÁÜ±ÈñÄÊ≠åÊõ≤
        </button>
        <button @click="setCurrentMode('favorites')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700 transition-colors"
                :class="{ 'bg-gray-700': currentMode === 'favorites' }">
          <font-awesome-icon icon="heart" class="mr-3" />
          ÊàëÁöÑÊî∂Ëóè
        </button>
      </nav>

      <!-- ÈåØË™§È°ØÁ§∫ÂçÄÂ°äÂ∑≤Èö±Ëóè -->
      <!-- 
      <div v-if="lastError" class="mt-4">
        <div class="bg-red-900 p-3 rounded-lg">
          <div class="flex items-center text-red-300 text-sm">
            <font-awesome-icon icon="exclamation-triangle" class="mr-2" />
            <span>{{ lastError }}</span>
          </div>
          <button @click="clearError" class="text-red-200 text-xs mt-1 underline">
            Ê∏ÖÈô§ÈåØË™§
          </button>
        </div>
      </div>
      -->
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
    <div class="flex-1 main-content">
      <!-- È†ÇÈÉ®Êí≠ÊîæÂô® -->
      <div class="bg-gray-800 p-6 text-white">
        <div class="flex items-center justify-between">
          <!-- Â∑¶ÂÅ¥ÔºöÁï∂ÂâçÊí≠ÊîæÊ≠åÊõ≤ -->
          <div class="flex items-center min-w-0 flex-1" v-if="currentTrack.name">
            <!-- Â∞ÅÈù¢ -->
            <div class="w-20 h-20 rounded-lg mr-4 overflow-hidden flex-shrink-0">
              <img v-if="currentTrack.image" 
                   :src="currentTrack.image" 
                   :alt="currentTrack.name" 
                   class="w-full h-full object-cover"
                   @error="handleImageError" />
              <div v-else class="w-full h-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                <font-awesome-icon icon="music" class="text-white text-2xl" />
              </div>
            </div>
            <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
            <div class="min-w-0 flex-1 max-w-xs">
              <p class="font-medium text-lg leading-tight max-h-12 overflow-hidden" 
                 :title="currentTrack.name"
                 style="line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                {{ currentTrack.name }}
              </p>
              <p class="text-sm text-gray-300 truncate mt-1" :title="currentTrack.artist_name">
                {{ currentTrack.artist_name }}
              </p>
              <p class="text-xs text-orange-400 truncate" v-if="currentTrack.album_name" :title="currentTrack.album_name">
                {{ currentTrack.album_name }}
              </p>
            </div>
          </div>
          <div v-else class="flex items-center min-w-0 flex-1">
            <div class="text-gray-400 text-sm">
              <font-awesome-icon icon="music" class="mr-2" />
              ÈÅ∏Êìá‰∏ÄÈ¶ñÊ≠åÊõ≤ÈñãÂßãÊí≠Êîæ
            </div>
          </div>

          <!-- Âè≥ÂÅ¥ÔºöÊí≠ÊîæÊéßÂà∂ÂíåÈü≥Èáè -->
          <div class="flex items-center space-x-4 flex-shrink-0">
            <!-- ËºâÂÖ•ÊåáÁ§∫Âô® -->
            <div v-if="isLoadingTrack" class="flex items-center text-orange-400">
              <font-awesome-icon icon="spinner" class="animate-spin mr-2" />
              <span class="text-sm">ËºâÂÖ•‰∏≠...</span>
            </div>
            
            <!-- ÊîπÈÄ≤ÁöÑÈü≥È†ªÂùáË°°Âô®Ë¶ñË¶∫ÊïàÊûú -->
            <div class="audio-visualizer" v-show="!isLoadingTrack">
              <div class="equalizer-bars">
                <div 
                  v-for="i in 16" 
                  :key="i" 
                  class="equalizer-bar"
                  :ref="el => { if (el) equalizerBars[i-1] = el }"
                  :data-freq-group="getFrequencyGroup(i-1)"
                ></div>
              </div>
            </div>
            
            <!-- Êí≠ÊîæÊéßÂà∂ÊåâÈàï -->
            <div class="play-controls-container">
              <button @click="handlePreviousTrack" class="control-button" :disabled="!currentTrack.name || isLoadingTrack">
                <font-awesome-icon icon="step-backward" class="text-lg" />
              </button>
              <button @click="handleTogglePlay" class="control-button" :disabled="!currentTrack.name">
                <font-awesome-icon v-if="isLoadingTrack" icon="spinner" class="text-lg animate-spin" />
                <font-awesome-icon v-else :icon="isPlaying ? 'pause' : 'play'" class="text-lg" />
              </button>
              <button @click="handleNextTrack" class="control-button" :disabled="!currentTrack.name || isLoadingTrack">
                <font-awesome-icon icon="step-forward" class="text-lg" />
              </button>
            </div>
            
            <!-- ÈÄ≤Â∫¶Ê¢ùÂçÄÂüü -->
            <div class="flex items-center space-x-2" style="min-width: 170px;">
              <span class="text-xs text-gray-300 w-12 text-right">{{ formatTime(currentTime) }}</span>
              <div class="flex-1 bg-gray-600 rounded-full h-2 cursor-pointer relative" @click="handleSeek">
                <div class="progress-bar h-2 rounded-full absolute top-0 left-0" 
                     :style="{ width: progressPercentage + '%' }"></div>
              </div>
              <span class="text-xs text-gray-300 w-6">{{ formatTime(duration) }}</span>
            </div>

            <!-- Êí≠ÊîæÊ®°ÂºèÊéßÂà∂ -->
            <div class="flex items-center space-x-2">
              <button @click="toggleShuffle" class="btn btn-circle bg-transparent text-white hover:bg-gray-700"
                      :class="{ 'text-orange-400': isShuffled }">
                <font-awesome-icon icon="random" class="text-lg" />
              </button>
              <button @click="toggleRepeat" class="btn btn-circle bg-transparent text-white hover:bg-gray-700"
                      :class="{ 'text-orange-400': repeatMode !== 'off' }">
                <font-awesome-icon :icon="repeatMode === 'one' ? 'redo' : 'repeat'" class="text-lg" />
              </button>
            </div>

            <!-- Èü≥ÈáèÊéßÂà∂ -->
            <div class="flex items-center space-x-2">
              <button class="btn btn-circle bg-transparent text-white hover:bg-gray-700">
                <font-awesome-icon :icon="getVolumeIcon()" class="text-lg" />
              </button>
              <input 
                type="range" 
                min="0" 
                max="100" 
                v-model="volume" 
                @input="handleVolumeChange"
                class="volume-slider w-20 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
              />
              <span class="text-xs text-gray-300 w-8">{{ volume }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ÊêúÂ∞ãÊ¨ÑÂíåÊ∑∑ÂíåÊõ≤È¢®Êí≠ÊîæÊ∏ÖÂñÆÊéßÂà∂ -->
      <div v-if="isJamendoConnected" class="p-2 pb-0 space-y-4">
        <!-- ÊêúÂ∞ãÊ¨Ñ -->
        <div class="relative inline-block w-full">
          <input v-model="searchQuery" @input="debouncedSearch" 
                 placeholder="üîéÊêúÂ∞ãÊ≠åÊõ≤„ÄÅËóù‰∫∫ÊàñÂ∞àËºØ..." 
                 class="w-full py-1 my-0 px-4 border border-black rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
 />
        </div>

        <!-- üÜï ‰øÆÊîπÔºöÈü≥Ê®ÇÊí≠ÊîæÊ∏ÖÂñÆÊéßÂà∂ -->
        <div class="p-4 bg-gradient-to-r from-blue-900 to-black-600 rounded-lg">
          <div class="flex items-center space-x-4 flex-wrap">
            <!-- Á¨¨‰∏ÄÂÄãÊõ≤È¢®ÊåâÈàïÁµÑ -->
            <div class="flex items-center space-x-2">
              <div class="relative">
                <button @click="toggleGenreDropdown(0)" 
                        class="genre-selector-btn px-6 py-3 bg-blue-100 text-blue rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[0].genre }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <!-- üîß ‰øÆÊîπÔºöÊµÆÂãïÂºèÊõ≤È¢®‰∏ãÊãâÈÅ∏ÂñÆ -->
                <div v-if="genreDropdownOpen[0]" class="floating-dropdown">
                  <div v-for="genre in availableGenres" :key="genre.value" 
                       @click="selectGenre(0, genre)" 
                       class="dropdown-item">
                    {{ genre.label }}
                  </div>
                </div>
              </div>
              <div class="relative">
                <button @click="toggleCountDropdown(0)" 
                        class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[0].count }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <!-- üîß ‰øÆÊîπÔºöÊµÆÂãïÂºèÊï∏Â≠ó‰∏ãÊãâÈÅ∏ÂñÆ -->
                <div v-if="countDropdownOpen[0]" class="floating-dropdown">
                  <div v-for="count in [1, 2, 3, 4, 5]" :key="count" 
                       @click="selectCount(0, count)" 
                       class="dropdown-item">
                    {{ count }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Âä†Ëôü -->
            <div class="text-white text-2xl font-bold">+</div>

            <!-- Á¨¨‰∫åÂÄãÊõ≤È¢®ÊåâÈàïÁµÑ -->
            <div class="flex items-center space-x-2">
              <div class="relative">
                <button @click="toggleGenreDropdown(1)" 
                        class="genre-selector-btn px-6 py-3 bg-blue-100 text-black rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[1].genre }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <div v-if="genreDropdownOpen[1]" class="floating-dropdown">
                  <div v-for="genre in availableGenres" :key="genre.value" 
                       @click="selectGenre(1, genre)" 
                       class="dropdown-item">
                    {{ genre.label }}
                  </div>
                </div>
              </div>
              <div class="relative">
                <button @click="toggleCountDropdown(1)" 
                        class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[1].count }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <div v-if="countDropdownOpen[1]" class="floating-dropdown">
                  <div v-for="count in [1, 2, 3, 4, 5]" :key="count" 
                       @click="selectCount(1, count)" 
                       class="dropdown-item">
                    {{ count }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Âä†Ëôü -->
            <div class="text-white text-2xl font-bold">+</div>

            <!-- Á¨¨‰∏âÂÄãÊõ≤È¢®ÊåâÈàïÁµÑ -->
            <div class="flex items-center space-x-2">
              <div class="relative">
                <button @click="toggleGenreDropdown(2)" 
                        class="genre-selector-btn px-6 py-3 bg-blue-100 text-black rounded-lg font-semibold hover:bg-blue-300 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[2].genre }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <div v-if="genreDropdownOpen[2]" class="floating-dropdown">
                  <div v-for="genre in availableGenres" :key="genre.value" 
                       @click="selectGenre(2, genre)" 
                       class="dropdown-item">
                    {{ genre.label }}
                  </div>
                </div>
              </div>
              <div class="relative">
                <button @click="toggleCountDropdown(2)" 
                        class="count-selector-btn px-4 py-3 bg-blue-300 text-black rounded-lg font-bold hover:bg-blue-100 flex items-center space-x-2 cursor-pointer">
                  <span>{{ playlistConfig[2].count }}</span>
                  <font-awesome-icon icon="chevron-down" class="text-sm" />
                </button>
                <div v-if="countDropdownOpen[2]" class="floating-dropdown">
                  <div v-for="count in [1, 2, 3, 4, 5]" :key="count" 
                       @click="selectCount(2, count)" 
                       class="dropdown-item">
                    {{ count }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Êí≠ÊîæÊåâÈàï -->
            <button @click="startCustomPlaylist" 
                    :disabled="isGeneratingPlaylist"
                    class="play-playlist-btn px-6 py-3 bg-orange-400 text-black hover:bg-gray-700 rounded-lg font-bold hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2 cursor-pointer">
              <font-awesome-icon v-if="isGeneratingPlaylist" icon="spinner" class="animate-spin" />
              <font-awesome-icon v-else icon="play" />
              <span v-if="isGeneratingPlaylist">ÁîüÊàê‰∏≠...</span>
              <span v-else>Êí≠Êîæ</span>
            </button>

            <!-- üÜï Êñ∞Â¢ûÔºöÊ∑∑ÂíåÊõ≤È¢®Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖãÈ°ØÁ§∫ - ÁßªÂà∞Êí≠ÊîæÊåâÈàïÂè≥ÈÇä -->
            <div v-if="customPlaylistStatus.isActive && currentMode === 'custom'" class="custom-playlist-status bg-blue-900/50 px-4 py-2 rounded-lg">
              <div class="text-xs text-blue-200 mb-1">Ê∑∑ÂíåÊõ≤È¢®Êí≠ÊîæÊ∏ÖÂñÆ</div>
              <div class="text-sm font-medium text-white">
                Á¨¨{{ customPlaylistStatus.currentGroup }}ÁµÑ {{ customPlaylistStatus.currentGenre }} 
                ({{ customPlaylistStatus.currentInGroup }}/{{ customPlaylistStatus.totalInGroup }})
              </div>
              <div class="text-xs text-blue-300 mt-1">
                Á∏ΩÈÄ≤Â∫¶: {{ customPlaylistStatus.overallProgress }}/{{ customPlaylistStatus.totalTracks }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
      <div class="p-6">
        <!-- Jamendo Êõ≤È¢®ÊåâÈàï -->
        <div v-if="isJamendoConnected && currentMode !== 'favorites'">
          <div class="grid grid-cols-5 gap-4 mb-4">
            <button v-for="tag in jamendoTags.slice(0, 5)" :key="tag" 
                    @click="searchByTag(tag)"
                    class="genre-btn-new py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105"
                    :class="getGenreButtonClass(tag)">
              {{ getGenreDisplayName(tag) }}
            </button>
          </div>
          <div class="grid grid-cols-5 gap-4 mb-8">
            <button v-for="tag in jamendoTags.slice(5, 10)" :key="tag" 
                    @click="searchByTag(tag)"
                    class="genre-btn-new py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105"
                    :class="getGenreButtonClass(tag)">
              {{ getGenreDisplayName(tag) }}
            </button>
          </div>
        </div>

        <!-- ÊàëÁöÑÊî∂ËóèÊ®ôÈ°å -->
        <div v-if="currentMode === 'favorites'" class="mb-6">
          <h2 class="text-2xl font-bold text-gray-300 flex items-center">
            <font-awesome-icon icon="heart" class="mr-2 text-red-500" />
            ÊàëÁöÑÊî∂Ëóè ({{ favoriteTrackIds.size }} È¶ñ)
          </h2>
          <p class="text-gray-300 text-sm mt-1">‰Ω†Êî∂ËóèÁöÑÈü≥Ê®ÇÊ∏ÖÂñÆ</p>
        </div>

        <!-- ËºâÂÖ•‰∏≠ -->
        <div v-if="loading" class="flex justify-center items-center h-32 mb-6">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
          <span class="ml-3 text-lg">ËºâÂÖ•‰∏≠...</span>
        </div>

        <!-- Èü≥Ê®ÇÂç°Áâá -->
        <div class="grid grid-cols-6 gap-4">
          <div v-for="track in displayedTracks" :key="track.id" 
               class="music-card bg-white rounded-lg p-3 shadow-md hover:shadow-lg cursor-pointer border relative"
               :class="{ 'ring-2 ring-orange-500': currentTrack.id === track.id }">
            
            <!-- ÊÑõÂøÉÊî∂ËóèÊåâÈàï -->
            <button @click.stop="toggleFavorite(track)" 
                    class="absolute top-2 right-2 z-10 p-2 rounded-full bg-white/90 hover:bg-white transition-all duration-300 hover:scale-110 shadow-sm">
              <font-awesome-icon 
                :icon="isFavorite(track.id) ? ['fas', 'heart'] : ['far', 'heart']"
                class="text-sm transition-all duration-300"
                :class="isFavorite(track.id) ? 'text-pink-500 heart-filled' : 'text-gray-400 hover:text-gray-600 heart-outline'" />
            </button>
            
            <!-- Â∞ÅÈù¢ -->
            <div class="w-full h-24 rounded-lg mb-2 flex items-center justify-center overflow-hidden relative"
                 @click="handleTrackClick(track)">
              <img v-if="track.image" 
                   :src="track.image" 
                   :alt="track.name" 
                   class="w-full h-full object-cover"
                   @error="handleImageError" />
              <div v-else class="w-full h-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center">
                <font-awesome-icon icon="music" class="text-white text-2xl" />
              </div>
              
              <!-- Êí≠ÊîæÊåáÁ§∫Âô® -->
              <div v-if="currentTrack.id === track.id && isPlaying" 
                   class="absolute inset-0 bg-black/30 flex items-center justify-center">
                <div class="bg-orange-500 text-white rounded-full p-2 animate-pulse">
                  <font-awesome-icon icon="play" class="text-sm" />
                </div>
              </div>
              
              <!-- ËºâÂÖ•ÊåáÁ§∫Âô® -->
              <div v-if="currentTrack.id === track.id && isLoadingTrack" 
                   class="absolute inset-0 bg-black/30 flex items-center justify-center">
                <div class="bg-orange-500 text-white rounded-full p-2">
                  <font-awesome-icon icon="spinner" class="text-sm animate-spin" />
                </div>
              </div>
            </div>
            
            <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
            <div @click="handleTrackClick(track)" class="cursor-pointer">
              <h3 class="font-bold text-sm text-gray-800 truncate mb-1" :title="track.name">
                {{ track.name }}
              </h3>
              <p class="text-xs text-gray-600 truncate mb-1" :title="track.artist_name">
                {{ track.artist_name }}
              </p>
              <p class="text-xs text-gray-500 truncate mb-2" v-if="track.album_name" :title="track.album_name">
                {{ track.album_name }}
              </p>
              
              <!-- Â∫ïÈÉ®‰ø°ÊÅØ -->
              <div class="flex justify-between items-center text-xs">
                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full">Jamendo</span>
                <span class="text-gray-500" v-if="track.duration">
                  {{ formatTime(track.duration) }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Êú™ÈÄ£Êé• Jamendo ÊèêÁ§∫ -->
          <div v-if="!isJamendoConnected && jamendoConfigured" class="col-span-6 text-center py-16 text-gray-500">
            <font-awesome-icon icon="music" class="text-6xl mb-4 text-orange-400" />
            <h3 class="text-xl font-medium mb-2">ÈÄ£Êé• Jamendo</h3>
            <p class="text-sm mb-4">ÈÄ£Êé• Jamendo ‰æÜÊí≠ÊîæÂÖçË≤ªÁöÑ Creative Commons Èü≥Ê®Ç</p>
            <button @click="connectJamendo" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
              <font-awesome-icon icon="music" class="mr-2" />
              ÈÄ£Êé• Jamendo
            </button>
          </div>

          <!-- Jamendo Êú™ÈÖçÁΩÆÊèêÁ§∫ -->
          <div v-else-if="!jamendoConfigured" class="col-span-6 text-center py-16 text-gray-500">
            <font-awesome-icon icon="music" class="text-6xl mb-4 text-gray-400" />
            <h3 class="text-xl font-medium mb-2">Jamendo Êú™ÈÖçÁΩÆ</h3>
            <p class="text-sm mb-4">Ë´ãÂú®Áí∞Â¢ÉËÆäÊï∏‰∏≠Ë®≠ÁΩÆ VITE_JAMENDO_CLIENT_ID</p>
          </div>
          
          <!-- ÁÑ°Ê≠åÊõ≤ÊèêÁ§∫ -->
          <div v-else-if="!loading && displayedTracks.length === 0" 
               class="col-span-6 text-center py-16 text-gray-300">
            <font-awesome-icon :icon="currentMode === 'favorites' ? 'heart' : 'search'" class="text-6xl mb-4 text-gray-300" />
            <h3 class="text-xl font-medium mb-2">
              {{ currentMode === 'favorites' ? 'ÈÇÑÊ≤íÊúâÊî∂Ëóè' : 'ÊêúÂ∞ãÈü≥Ê®Ç' }}
            </h3>
            <p class="text-sm">
              {{ currentMode === 'favorites' ? 'ÈªûÊìäÊ≠åÊõ≤Âè≥‰∏äËßíÁöÑÊÑõÂøÉ‰æÜÊî∂ËóèÈü≥Ê®Ç' : '‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÊ¨ÑÊàñÈªûÊìäÊ®ôÁ±§ÊåâÈàï‰æÜÂ∞ãÊâæÈü≥Ê®Ç' }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import { useJamendo } from './composables/useJamendo'

// Jamendo ÁµÑÂêàÂºèÂáΩÊï∏
let jamendoComposable = null

try {
  jamendoComposable = useJamendo()
} catch (error) {
  console.warn('useJamendo ÂàùÂßãÂåñÂ§±Êïó:', error)
  // ÂâµÂª∫Á©∫ÁöÑÊõø‰ª£Â∞çË±°
  jamendoComposable = {
    isJamendoConnected: ref(false),
    jamendoConfigured: ref(false),
    currentTrack: ref({}),
    isPlaying: ref(false),
    currentTime: ref(0),
    duration: ref(0),
    volume: ref(50),
    isShuffled: ref(false),
    repeatMode: ref('off'),
    currentPlaylist: ref([]),
    currentTrackIndex: ref(0),
    autoPlayNext: ref(true),
    lastError: ref(''),
    isLoadingTrack: ref(false),
    connectJamendo: () => Promise.resolve(),
    disconnectJamendo: () => {},
    playTrack: () => Promise.resolve(),
    togglePlay: () => Promise.resolve(),
    previousTrack: () => Promise.resolve(),
    nextTrack: () => Promise.resolve(),
    seek: () => Promise.resolve(),
    setVolume: () => Promise.resolve(),
    toggleShuffle: () => Promise.resolve(),
    toggleRepeat: () => Promise.resolve(),
    searchTracks: () => Promise.resolve([]),
    getTracksByTag: () => Promise.resolve([]),
    getPopularTracks: () => Promise.resolve([]),
    getLatestTracks: () => Promise.resolve([]),
    getRandomTracks: () => Promise.resolve([]),
    setPlaylist: () => {},
    clearPlaylist: () => {},
    playNextInPlaylist: () => Promise.resolve(),
    getAvailableTags: () => Promise.resolve([])
  }
}

const {
  isJamendoConnected,
  jamendoConfigured,
  currentTrack,
  isPlaying,
  currentTime,
  duration,
  volume,
  isShuffled,
  repeatMode,
  currentPlaylist,
  currentTrackIndex,
  autoPlayNext,
  lastError,
  isLoadingTrack,
  connectJamendo,
  disconnectJamendo,
  playTrack,
  togglePlay,
  previousTrack,
  nextTrack,
  seek,
  setVolume,
  toggleShuffle,
  toggleRepeat,
  searchTracks: jamendoSearch,
  getTracksByTag,
  getPopularTracks,
  getLatestTracks,
  getRandomTracks,
  setPlaylist,
  clearPlaylist,
  playNextInPlaylist,
  getAvailableTags
} = jamendoComposable

// Âü∫Êú¨Êï∏Êìö
const currentMode = ref('popular')
const loading = ref(false)
const searchQuery = ref('')
const displayedTracks = ref([])

// Êî∂ËóèÂäüËÉΩ
const favoriteTrackIds = ref(new Set())
const favoriteTracks = ref([])

// ËøΩËπ§Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§
const selectedTag = ref('')

// Jamendo API ÂÆòÊñπÊé®Ëñ¶ÁöÑ10ÂÄãÊõ≤È¢®
const jamendoTags = ref([
  'pop',        // ÊµÅË°åÈü≥Ê®Ç
  'rock',       // ÊêñÊªæÈü≥Ê®Ç  
  'electronic', // ÈõªÂ≠êÈü≥Ê®Ç
  'jazz',       // ÁàµÂ£´Èü≥Ê®Ç
  'classical',  // Âè§ÂÖ∏Èü≥Ê®Ç
  'hiphop',     // ÂòªÂìàÈü≥Ê®Ç
  'metal',      // ÈáëÂ±¨Èü≥Ê®Ç
  'world',      // ‰∏ñÁïåÈü≥Ê®Ç
  'soundtrack', // ÈÖçÊ®ÇÈü≥Ê®Ç
  'lounge'      // ‰ºëÈñíÈü≥Ê®Ç
])

// Êõ≤È¢®ÂêçÁ®±‰∏≠Ëã±Â∞çÁÖß
const genreNameMap = {
  'pop': 'POP',
  'rock': 'ROCK', 
  'electronic': 'ELECTRONIC',
  'jazz': 'JAZZ',
  'classical': 'CLASSICAL',
  'hiphop': 'HIP HOP',
  'metal': 'METAL',
  'world': 'WORLD',
  'soundtrack': 'SOUNDTRACK',
  'lounge': 'LOUNGE'
}

// Èü≥È†ªÂùáË°°Âô®Áõ∏Èóú
const equalizerBars = ref([])
const audioFrequencyData = ref(Array(16).fill(0.2))

// üÜï Êñ∞Â¢ûÔºöËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÂäüËÉΩ
const playlistConfig = ref([
  { genre: 'Jazz', count: 3 },
  { genre: 'Country', count: 5 },
  { genre: 'Rock', count: 1 }
])

const genreDropdownOpen = ref([false, false, false])
const countDropdownOpen = ref([false, false, false])
const isGeneratingPlaylist = ref(false)

// üÜï Êñ∞Â¢ûÔºöËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖãËøΩËπ§
const customPlaylistStatus = ref({
  isActive: false,
  currentGroup: 1,
  currentGenre: 'Jazz',
  currentInGroup: 1,
  totalInGroup: 3,
  overallProgress: 1,
  totalTracks: 9,
  groupBreakpoints: [], // Ë®òÈåÑÊØèÁµÑÁöÑËµ∑ÂßãÂíåÁµêÊùüÁ¥¢Âºï
  originalConfig: [] // ‰øùÂ≠òÂéüÂßãÈÖçÁΩÆ
})

// ÂèØÁî®ÁöÑÊõ≤È¢®ÈÅ∏È†Ö
const availableGenres = [
  { label: 'Pop', value: 'pop' },
  { label: 'Rock', value: 'rock' },
  { label: 'Hip Hop', value: 'hiphop' },
  { label: 'Electronic', value: 'electronic' },
  { label: 'Jazz', value: 'jazz' },
  { label: 'Classical', value: 'classical' },
  { label: 'Metal', value: 'metal' },
  { label: 'Lounge', value: 'lounge' },
  { label: 'Soundtrack', value: 'soundtrack' },
  { label: 'World', value: 'world' }
]

// ÊêúÂ∞ãÈò≤Êäñ
let searchTimeout = null
const debouncedSearch = () => {
  if (searchTimeout) clearTimeout(searchTimeout)
  searchTimeout = setTimeout(() => {
    searchTracks()
  }, 500)
}

// üÜï Êñ∞Â¢ûÔºöËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÊéßÂà∂ÂáΩÊï∏
const toggleGenreDropdown = (index) => {
  // ÈóúÈñâÂÖ∂‰ªñ‰∏ãÊãâÈÅ∏ÂñÆ
  genreDropdownOpen.value = genreDropdownOpen.value.map((_, i) => i === index ? !genreDropdownOpen.value[i] : false)
  countDropdownOpen.value = countDropdownOpen.value.map(() => false)
}

const toggleCountDropdown = (index) => {
  // ÈóúÈñâÂÖ∂‰ªñ‰∏ãÊãâÈÅ∏ÂñÆ
  countDropdownOpen.value = countDropdownOpen.value.map((_, i) => i === index ? !countDropdownOpen.value[i] : false)
  genreDropdownOpen.value = genreDropdownOpen.value.map(() => false)
}

const selectGenre = (index, genre) => {
  playlistConfig.value[index].genre = genre.label
  genreDropdownOpen.value[index] = false
  console.log(`ÈÅ∏ÊìáÊõ≤È¢® ${index + 1}: ${genre.label}`)
}

const selectCount = (index, count) => {
  playlistConfig.value[index].count = count
  countDropdownOpen.value[index] = false
  console.log(`ÈÅ∏ÊìáÊï∏Èáè ${index + 1}: ${count}`)
}

// üÜï Êñ∞Â¢ûÔºöÊõ¥Êñ∞Ëá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖã
const updateCustomPlaylistStatus = () => {
  if (!customPlaylistStatus.value.isActive || currentPlaylist.value.length === 0) {
    return
  }
  
  const currentIndex = currentTrackIndex.value
  const breakpoints = customPlaylistStatus.value.groupBreakpoints
  
  // ÊâæÂà∞Áï∂ÂâçÊ≠åÊõ≤Â±¨ÊñºÂì™‰∏ÄÁµÑ
  let currentGroup = 1
  let currentInGroup = 1
  let totalInGroup = 1
  let currentGenre = 'Unknown'
  
  for (let i = 0; i < breakpoints.length; i++) {
    if (currentIndex >= breakpoints[i].start && currentIndex <= breakpoints[i].end) {
      currentGroup = i + 1
      currentInGroup = currentIndex - breakpoints[i].start + 1
      totalInGroup = breakpoints[i].end - breakpoints[i].start + 1
      currentGenre = breakpoints[i].genre
      break
    }
  }
  
  customPlaylistStatus.value.currentGroup = currentGroup
  customPlaylistStatus.value.currentGenre = currentGenre
  customPlaylistStatus.value.currentInGroup = currentInGroup
  customPlaylistStatus.value.totalInGroup = totalInGroup
  customPlaylistStatus.value.overallProgress = currentIndex + 1
  
  console.log('üìä Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖãÊõ¥Êñ∞:', {
    group: `${currentGroup}/${breakpoints.length}`,
    inGroup: `${currentInGroup}/${totalInGroup}`,
    overall: `${currentIndex + 1}/${currentPlaylist.value.length}`,
    genre: currentGenre
  })
}

// üÜï Êñ∞Â¢ûÔºöÊîπÈÄ≤ÁöÑÁç≤ÂèñÊ≠åÊõ≤ÂáΩÊï∏ÔºàÂåÖÂê´ÂÇôÊ°àÊ©üÂà∂Ôºâ
const getTracksWithFallback = async (genreValue, genreLabel, count) => {
  try {
    console.log(`üéµ ÂòóË©¶ÊåâÊ®ôÁ±§Áç≤Âèñ ${genreLabel} Ê≠åÊõ≤...`)
    
    // ÊñπÊ°à1ÔºöÊåâÊ®ôÁ±§ÊêúÂ∞ã
    if (getTracksByTag && typeof getTracksByTag === 'function') {
      const tracks = await getTracksByTag(genreValue, { limit: Math.max(count, 15) })
      
      if (tracks && tracks.length > 0) {
        console.log(`‚úÖ ÊåâÊ®ôÁ±§ÊâæÂà∞ ${tracks.length} È¶ñ ${genreLabel} Ê≠åÊõ≤`)
        return tracks
      }
    }
    
    console.log(`‚ö†Ô∏è ÊåâÊ®ôÁ±§ÊêúÂ∞ã ${genreLabel} Â§±ÊïóÔºåÂòóË©¶ÊñáÂ≠óÊêúÂ∞ã...`)
    
    // ÊñπÊ°à2ÔºöÁõ¥Êé•ÊêúÂ∞ãÊõ≤È¢®ÂêçÁ®±
    if (jamendoSearch && typeof jamendoSearch === 'function') {
      const searchResults = await jamendoSearch(genreLabel, { limit: Math.max(count, 15) })
      
      if (searchResults && searchResults.length > 0) {
        console.log(`‚úÖ ÊêúÂ∞ãÊâæÂà∞ ${searchResults.length} È¶ñ ${genreLabel} Áõ∏ÈóúÊ≠åÊõ≤`)
        return searchResults
      }
    }
    
    console.log(`‚ö†Ô∏è ÊêúÂ∞ã ${genreLabel} ‰πüÂ§±ÊïóÔºåÂòóË©¶Áç≤ÂèñÁÜ±ÈñÄÊ≠åÊõ≤...`)
    
    // ÊñπÊ°à3ÔºöÁç≤ÂèñÁÜ±ÈñÄÊ≠åÊõ≤‰ΩúÁÇ∫ÂÇôÊ°à
    if (getPopularTracks && typeof getPopularTracks === 'function') {
      const popularTracks = await getPopularTracks({ limit: Math.max(count, 10) })
      
      if (popularTracks && popularTracks.length > 0) {
        console.log(`‚úÖ ‰ΩøÁî®ÁÜ±ÈñÄÊ≠åÊõ≤‰ΩúÁÇ∫ ${genreLabel} ÁöÑÂÇôÊ°à`)
        return popularTracks
      }
    }
    
    console.error(`‚ùå ÊâÄÊúâÊñπÊ°àÈÉΩÂ§±ÊïóÔºåÁÑ°Ê≥ïÁç≤Âèñ ${genreLabel} Ê≠åÊõ≤`)
    return []
    
  } catch (error) {
    console.error(`‚ùå Áç≤Âèñ ${genreLabel} Ê≠åÊõ≤ÊôÇÂá∫ÈåØ:`, error)
    return []
  }
}

// üÜï Êñ∞Â¢ûÔºöÁîüÊàê‰∏¶Êí≠ÊîæËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÔºàÊîπÈÄ≤ÁâàÔºâ
const startCustomPlaylist = async () => {
  try {
    isGeneratingPlaylist.value = true
    console.log('üéµ ÈñãÂßãÁîüÊàêËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆ...', playlistConfig.value)
    
    const customPlaylist = []
    const groupBreakpoints = []
    let currentIndex = 0
    
    // ‰øùÂ≠òÂéüÂßãÈÖçÁΩÆ
    customPlaylistStatus.value.originalConfig = [...playlistConfig.value]
    
    // ÊåâÈ†ÜÂ∫èÁÇ∫ÊØèÂÄãÊõ≤È¢®Áç≤ÂèñÊåáÂÆöÊï∏ÈáèÁöÑÊ≠åÊõ≤
    for (let i = 0; i < playlistConfig.value.length; i++) {
      const config = playlistConfig.value[i]
      const genreValue = availableGenres.find(g => g.label === config.genre)?.value || 'pop'
      
      console.log(`üìã Áç≤Âèñ ${config.genre} ÁöÑ ${config.count} È¶ñÊ≠å...`)
      
      try {
        // üîß ‰ΩøÁî®ÊîπÈÄ≤ÁöÑÁç≤ÂèñÂáΩÊï∏ÔºàÂåÖÂê´ÂÇôÊ°àÊ©üÂà∂Ôºâ
        const tracks = await getTracksWithFallback(genreValue, config.genre, config.count)
        
        if (tracks.length > 0) {
          // üîß ÈÅéÊøæÊéâÂèØËÉΩÊúâÂïèÈ°åÁöÑÈü≥Ëªå
          const validTracks = tracks.filter(track => {
            const hasValidUrl = track.audio || track.audiodownload
            const hasBasicInfo = track.name && track.artist_name
            return hasValidUrl && hasBasicInfo
          })
          
          // ÂèñÂâç N È¶ñÊ≠åÔºàÊ†πÊìöÁî®Êà∂Ë®≠ÂÆöÁöÑÊï∏ÈáèÔºâ
          const selectedTracks = validTracks.slice(0, config.count)
          
          if (selectedTracks.length > 0) {
            // Ë®òÈåÑÈÄô‰∏ÄÁµÑÁöÑÁ¥¢ÂºïÁØÑÂúç
            const groupStart = currentIndex
            const groupEnd = currentIndex + selectedTracks.length - 1
            
            groupBreakpoints.push({
              genre: config.genre,
              start: groupStart,
              end: groupEnd,
              count: selectedTracks.length
            })
            
            customPlaylist.push(...selectedTracks)
            currentIndex += selectedTracks.length
            
            console.log(`‚úÖ Â∑≤Ê∑ªÂä† ${selectedTracks.length} È¶ñ ${config.genre} Ê≠åÊõ≤ (Á¥¢Âºï ${groupStart}-${groupEnd})`)
          } else {
            console.warn(`‚ö†Ô∏è ${config.genre} Êõ≤È¢®Ê≤íÊúâÊúâÊïàÁöÑÊ≠åÊõ≤`)
          }
        } else {
          console.warn(`‚ö†Ô∏è Ê≤íÊúâÊâæÂà∞ ${config.genre} Êõ≤È¢®ÁöÑÊ≠åÊõ≤`)
        }
      } catch (error) {
        console.error(`‚ùå Áç≤Âèñ ${config.genre} Ê≠åÊõ≤Â§±Êïó:`, error)
        continue
      }
    }
    
    if (customPlaylist.length === 0) {
      console.warn('‚ö†Ô∏è Ê≤íÊúâÊâæÂà∞‰ªª‰ΩïÊ≠åÊõ≤')
      // lastError.value = 'ÁÑ°Ê≥ïÁîüÊàêÊí≠ÊîæÊ∏ÖÂñÆÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•ÊàñÂòóË©¶ÂÖ∂‰ªñÊõ≤È¢®'
      return
    }
    
    console.log(`üéâ Êí≠ÊîæÊ∏ÖÂñÆÁîüÊàêÂÆåÊàêÔºåÂÖ± ${customPlaylist.length} È¶ñÊ≠åÊõ≤`)
    console.log('üìä ÁµÑÂà•ÂàÜ‰Ωà:', groupBreakpoints)
    
    // üîß Ë®≠ÁΩÆÁãÄÊÖãËøΩËπ§
    customPlaylistStatus.value.isActive = true
    customPlaylistStatus.value.groupBreakpoints = groupBreakpoints
    customPlaylistStatus.value.totalTracks = customPlaylist.length
    customPlaylistStatus.value.overallProgress = 1
    
    // üîß Ê∏ÖÈô§‰πãÂâçÁöÑÈåØË™§
    // lastError.value = ''
    
    // Ë®≠ÁΩÆÊí≠ÊîæÊ∏ÖÂñÆ‰∏¶ÈñãÂßãÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñÊ≠å
    if (setPlaylist && typeof setPlaylist === 'function') {
      setPlaylist(customPlaylist, 0)
    }
    
    // üîß ÂòóË©¶Êí≠ÊîæÁ¨¨‰∏ÄÈ¶ñÊ≠åÔºåÂ§±ÊïóÂâáËá™ÂãïË∑≥Âà∞‰∏ã‰∏ÄÈ¶ñ
    await playFirstAvailableTrack(customPlaylist)
    
    // È°ØÁ§∫Êí≠ÊîæÊ∏ÖÂñÆË©≥ÊÉÖ
    displayedTracks.value = customPlaylist
    currentMode.value = 'custom'
    
    // ÂàùÂßãÂåñÁãÄÊÖãÈ°ØÁ§∫
    updateCustomPlaylistStatus()
    
  } catch (error) {
    console.error('‚ùå ÁîüÊàêËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÂ§±Êïó:', error)
    // lastError.value = 'ÁîüÊàêÊí≠ÊîæÊ∏ÖÂñÆÂ§±Êïó: ' + error.message
  } finally {
    isGeneratingPlaylist.value = false
  }
}

// üÜï Êñ∞Â¢ûÔºöÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñÂèØÁî®ÁöÑÊ≠åÊõ≤
const playFirstAvailableTrack = async (playlist) => {
  for (let i = 0; i < Math.min(playlist.length, 5); i++) {
    try {
      console.log(`üéµ ÂòóË©¶Êí≠ÊîæÁ¨¨ ${i + 1} È¶ñÊ≠å: ${playlist[i].name}`)
      
      if (playTrack && typeof playTrack === 'function') {
        await playTrack(playlist[i], playlist, i)
        console.log(`‚úÖ ÊàêÂäüÊí≠ÊîæÁ¨¨ ${i + 1} È¶ñÊ≠å`)
        return
      }
    } catch (playError) {
      console.error(`‚ùå Êí≠ÊîæÁ¨¨ ${i + 1} È¶ñÊ≠åÂ§±Êïó:`, playError)
      
      if (i < Math.min(playlist.length, 5) - 1) {
        console.log(`üîÑ ÂòóË©¶Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ...`)
        continue
      } else {
        console.error(`‚ùå Ââç ${Math.min(playlist.length, 5)} È¶ñÊ≠åÈÉΩÁÑ°Ê≥ïÊí≠Êîæ`)
        // lastError.value = 'Êí≠ÊîæÊ∏ÖÂñÆ‰∏≠ÁöÑÊ≠åÊõ≤ÂèØËÉΩÊúâÂïèÈ°åÔºåË´ãÂòóË©¶ÂÖ∂‰ªñÊõ≤È¢®'
        throw playError
      }
    }
  }
}

// üÜï Êñ∞Â¢ûÔºöÈªûÊìäÈ†ÅÈù¢ÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
const closeAllDropdowns = () => {
  genreDropdownOpen.value = [false, false, false]
  countDropdownOpen.value = [false, false, false]
}

// ÈåØË™§ËôïÁêÜÔºàÂ∑≤ÁßªÈô§ÈåØË™§Ê∏ÖÈô§ÂáΩÊï∏Ôºå‰ΩÜ‰øùÁïôÈåØË™§Ë®òÈåÑÔºâ
// const clearError = () => {
//   lastError.value = ''
// }

// ÂúñÁâáÈåØË™§ËôïÁêÜ
const handleImageError = (event) => {
  event.target.style.display = 'none'
}

// Êõ≤È¢®ÊåâÈàïÊ®£ÂºèÊéßÂà∂
const getGenreButtonClass = (tag) => {
  if (selectedTag.value === tag) {
    return 'bg-pink-500 text-white font-semibold shadow-lg hover:bg-pink-600'
  } else {
    return 'bg-white text-black font-medium shadow-md border border-gray-200 hover:bg-gray-50'
  }
}

// Áç≤ÂèñÊõ≤È¢®È°ØÁ§∫ÂêçÁ®±
const getGenreDisplayName = (tag) => {
  return genreNameMap[tag] || tag.toUpperCase()
}

// Áç≤ÂèñÈ†ªÁéáÁµÑ
const getFrequencyGroup = (index) => {
  if (index < 5) return 'bass'      // ‰ΩéÈü≥: 0-4
  if (index < 11) return 'mid'      // ‰∏≠Èü≥: 5-10
  return 'high'                     // È´òÈü≥: 11-15
}

// ÊîπÈÄ≤ÁöÑÈü≥È†ªÂùáË°°Âô®ÂãïÊÖãÊïàÊûú
const simulateRealisticAudioSpectrum = () => {
  if (!isPlaying.value) {
    audioFrequencyData.value = audioFrequencyData.value.map(value => 
      Math.max(0.1, value * 0.95)
    )
    updateEqualizerBars()
    return
  }
  
  const currentTimeMs = Date.now()
  const beatPeriod = 600
  const beatPhase = (currentTimeMs % beatPeriod) / beatPeriod
  const beatIntensity = Math.max(0, Math.sin(beatPhase * Math.PI * 2))
  
  audioFrequencyData.value = audioFrequencyData.value.map((currentValue, index) => {
    const freqGroup = getFrequencyGroup(index)
    let newValue = currentValue
    
    if (freqGroup === 'bass') {
      const bassPattern = beatIntensity * (0.8 + Math.sin(currentTimeMs * 0.003 + index) * 0.2)
      const bassRandom = 0.7 + Math.random() * 0.3
      newValue = bassPattern * bassRandom
      
      if (beatPhase < 0.1) {
        newValue = Math.min(1.0, newValue * 1.5)
      }
      
    } else if (freqGroup === 'mid') {
      const midBase = Math.sin(currentTimeMs * 0.005 + index * 0.8) * 0.4 + 0.5
      const midRhythm = Math.sin(beatPhase * Math.PI * 3) * 0.3
      const midRandom = 0.6 + Math.random() * 0.4
      newValue = (midBase + midRhythm) * midRandom
      
    } else {
      const highFreq = Math.sin(currentTimeMs * 0.008 + index * 1.5) * 0.5 + 0.4
      const highSpikes = Math.random() > 0.8 ? Math.random() * 0.6 : 0
      const highRandom = 0.5 + Math.random() * 0.5
      newValue = (highFreq + highSpikes) * highRandom
      
      if (beatPhase > 0.7 && beatPhase < 0.9 && Math.random() > 0.7) {
        newValue = Math.min(1.0, newValue * 2)
      }
    }
    
    const smoothing = freqGroup === 'bass' ? 0.8 : freqGroup === 'mid' ? 0.7 : 0.6
    return currentValue * smoothing + newValue * (1 - smoothing)
  })
  
  updateEqualizerBars()
}

// Êõ¥Êñ∞ÂùáË°°Âô®Ê¢ùÂΩ¢È°ØÁ§∫
const updateEqualizerBars = () => {
  equalizerBars.value.forEach((bar, index) => {
    if (!bar) return
    
    const intensity = audioFrequencyData.value[index]
    const height = Math.max(8, Math.min(90, intensity * 100))
    const freqGroup = getFrequencyGroup(index)
    
    bar.style.height = `${height}%`
    
    if (intensity > 0.8) {
      if (freqGroup === 'bass') {
        bar.style.background = 'linear-gradient(to top, #ff4500, #ff6347, #ffa500)'
      } else if (freqGroup === 'mid') {
        bar.style.background = 'linear-gradient(to top, #ffa500, #ffff00, #adff2f)'
      } else {
        bar.style.background = 'linear-gradient(to top, #ffff00, #ffffff, #87ceeb)'
      }
      bar.style.boxShadow = `0 0 ${intensity * 10}px rgba(255, 165, 0, ${intensity * 0.8})`
    } else if (intensity > 0.5) {
      if (freqGroup === 'bass') {
        bar.style.background = 'linear-gradient(to top, #ff6b35, #ff8c42, #ffa449)'
      } else if (freqGroup === 'mid') {
        bar.style.background = 'linear-gradient(to top, #f7931e, #ffab00, #ffc107)'
      } else {
        bar.style.background = 'linear-gradient(to top, #ffcc02, #ffeb3b, #fff200)'
      }
      bar.style.boxShadow = `0 0 ${intensity * 6}px rgba(255, 140, 0, ${intensity * 0.5})`
    } else {
      if (freqGroup === 'bass') {
        bar.style.background = 'linear-gradient(to top, #8b4513, #cd853f)'
      } else if (freqGroup === 'mid') {
        bar.style.background = 'linear-gradient(to top, #daa520, #f0e68c)'
      } else {
        bar.style.background = 'linear-gradient(to top, #f0e68c, #ffffe0)'
      }
      bar.style.boxShadow = 'none'
    }
    
    if (freqGroup === 'bass') {
      bar.style.filter = `saturate(${1 + intensity * 0.5})`
    } else if (freqGroup === 'high') {
      bar.style.filter = `brightness(${1 + intensity * 0.3}) contrast(${1 + intensity * 0.2})`
    } else {
      bar.style.filter = `hue-rotate(${intensity * 20}deg)`
    }
  })
}

// ÂùáË°°Âô®ÂãïÁï´ÊéßÂà∂
let equalizerInterval = null
const startEqualizerAnimation = () => {
  if (equalizerInterval) clearInterval(equalizerInterval)
  equalizerInterval = setInterval(simulateRealisticAudioSpectrum, 80)
}

const stopEqualizerAnimation = () => {
  if (equalizerInterval) {
    clearInterval(equalizerInterval)
    equalizerInterval = null
  }
  
  const fadeOut = () => {
    audioFrequencyData.value = audioFrequencyData.value.map(value => value * 0.9)
    updateEqualizerBars()
    
    if (Math.max(...audioFrequencyData.value) > 0.05) {
      setTimeout(fadeOut, 50)
    } else {
      audioFrequencyData.value.fill(0.1)
      equalizerBars.value.forEach(bar => {
        if (bar) {
          bar.style.height = '8%'
          bar.style.boxShadow = 'none'
          bar.style.filter = 'none'
          bar.style.background = 'linear-gradient(to top, #666, #999)'
        }
      })
    }
  }
  fadeOut()
}

// ÊîπÈÄ≤ÁöÑÊí≠ÊîæÊéßÂà∂ÂáΩÊï∏ - Èò≤Ê≠¢Á´∂Áà≠Ê¢ù‰ª∂
const handlePreviousTrack = async () => {
  try {
    console.log('‚èÆÔ∏è ÈªûÊìä‰∏ä‰∏ÄÈ¶ñÊåâÈàï')
    if (isLoadingTrack.value) {
      console.log('‚è≥ Ê≠åÊõ≤Ê≠£Âú®ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂÄô...')
      return
    }
    
    if (previousTrack && typeof previousTrack === 'function') {
      await previousTrack()
    } else {
      console.warn('previousTrack ÂáΩÊï∏‰∏çÂèØÁî®')
    }
  } catch (error) {
    console.error('‚ùå ‰∏ä‰∏ÄÈ¶ñÂ§±Êïó:', error)
  }
}

const handleNextTrack = async () => {
  try {
    console.log('‚è≠Ô∏è ÈªûÊìä‰∏ã‰∏ÄÈ¶ñÊåâÈàï')
    if (isLoadingTrack.value) {
      console.log('‚è≥ Ê≠åÊõ≤Ê≠£Âú®ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂÄô...')
      return
    }
    
    if (nextTrack && typeof nextTrack === 'function') {
      await nextTrack()
    } else {
      console.warn('nextTrack ÂáΩÊï∏‰∏çÂèØÁî®')
    }
  } catch (error) {
    console.error('‚ùå ‰∏ã‰∏ÄÈ¶ñÂ§±Êïó:', error)
  }
}

const handleTogglePlay = async () => {
  try {
    console.log('‚èØÔ∏è ÈªûÊìäÊí≠Êîæ/Êö´ÂÅúÊåâÈàï')
    
    if (!currentTrack.value.name) {
      console.warn('‚ö†Ô∏è Ê≤íÊúâÂèØÊí≠ÊîæÁöÑÈü≥Ëªå')
      return
    }
    
    if (togglePlay && typeof togglePlay === 'function') {
      await togglePlay()
    } else {
      console.warn('togglePlay ÂáΩÊï∏‰∏çÂèØÁî®')
    }
  } catch (error) {
    console.error('‚ùå Êí≠Êîæ/Êö´ÂÅúÂ§±Êïó:', error)
  }
}

// ÊîπÈÄ≤ÁöÑÊ≠åÊõ≤ÈªûÊìäËôïÁêÜ - Èò≤Ê≠¢ÈáçË§áÈªûÊìä
let isClickProcessing = false
const handleTrackClick = async (track) => {
  try {
    if (isClickProcessing || isLoadingTrack.value) {
      console.log('‚è≥ Ê≠£Âú®ËôïÁêÜ‰∏≠ÔºåË´ãÁ®çÂÄô...')
      return
    }
    
    isClickProcessing = true
    console.log('üéµ ÈªûÊìäÊ≠åÊõ≤:', track.name)
    
    if (playTrack && typeof playTrack === 'function') {
      await playTrack(track)
    } else {
      console.warn('playTrack ÂáΩÊï∏‰∏çÂèØÁî®')
    }
  } catch (error) {
    console.error('‚ùå Êí≠ÊîæÊ≠åÊõ≤Â§±Êïó:', error)
    // ‰∏çÂÜçÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØ
    // lastError.value = 'Êí≠ÊîæÂ§±Êïó: ' + error.message
  } finally {
    isClickProcessing = false
  }
}

// Êî∂ËóèÂäüËÉΩÊñπÊ≥ï
const isFavorite = (trackId) => {
  return favoriteTrackIds.value.has(trackId)
}

const toggleFavorite = (track) => {
  if (favoriteTrackIds.value.has(track.id)) {
    favoriteTrackIds.value.delete(track.id)
    favoriteTracks.value = favoriteTracks.value.filter(t => t.id !== track.id)
  } else {
    favoriteTrackIds.value.add(track.id)
    favoriteTracks.value.push(track)
  }
  
  if (currentMode.value === 'favorites') {
    displayedTracks.value = [...favoriteTracks.value]
  }
  
  saveFavoritesToStorage()
}

const saveFavoritesToStorage = () => {
  try {
    localStorage.setItem('favorite_tracks', JSON.stringify(favoriteTracks.value))
    localStorage.setItem('favorite_track_ids', JSON.stringify([...favoriteTrackIds.value]))
  } catch (error) {
    console.error('‰øùÂ≠òÊî∂ËóèÂ§±Êïó:', error)
  }
}

const loadFavoritesFromStorage = () => {
  try {
    const savedTracks = localStorage.getItem('favorite_tracks')
    const savedIds = localStorage.getItem('favorite_track_ids')
    
    if (savedTracks) {
      favoriteTracks.value = JSON.parse(savedTracks)
    }
    
    if (savedIds) {
      favoriteTrackIds.value = new Set(JSON.parse(savedIds))
    }
  } catch (error) {
    console.error('ËºâÂÖ•Êî∂ËóèÂ§±Êïó:', error)
  }
}

// Èü≥ÈáèÊéßÂà∂ÊñπÊ≥ï
const getVolumeIcon = () => {
  if (volume.value === 0) return 'volume-mute'
  if (volume.value < 30) return 'volume-down'
  if (volume.value < 70) return 'volume-down'
  return 'volume-up'
}

const handleVolumeChange = (event) => {
  const newVolume = parseInt(event.target.value)
  if (setVolume && typeof setVolume === 'function') {
    setVolume(newVolume)
  }
}

// ÊêúÂ∞ãÂäüËÉΩ
const searchTracks = async () => {
  if (!searchQuery.value.trim() || !isJamendoConnected.value) return
  
  loading.value = true
  selectedTag.value = ''
  
  try {
    if (jamendoSearch && typeof jamendoSearch === 'function') {
      const results = await jamendoSearch(searchQuery.value, { limit: 30 })
      displayedTracks.value = results
    }
  } catch (error) {
    console.error('ÊêúÂ∞ãÂ§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// ÈÄ≤Â∫¶Ê¢ùÈªûÊìäËôïÁêÜ
const handleSeek = (event) => {
  if (!duration.value || !seek || typeof seek !== 'function') return
  seek(event)
}

// ÊåâÊ®ôÁ±§ÊêúÂ∞ã
const searchByTag = async (tag) => {
  selectedTag.value = tag
  searchQuery.value = ''
  
  loading.value = true
  try {
    if (getTracksByTag && typeof getTracksByTag === 'function') {
      const results = await getTracksByTag(tag, { limit: 30 })
      displayedTracks.value = results
      console.log(`üéµ ÊêúÂ∞ã ${getGenreDisplayName(tag)} Êõ≤È¢®ÔºåÊâæÂà∞ ${results.length} È¶ñÊ≠åÊõ≤`)
    }
  } catch (error) {
    console.error('Ê®ôÁ±§ÊêúÂ∞ãÂ§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// Ë®≠ÁΩÆÊ®°Âºè
const setCurrentMode = async (mode) => {
  currentMode.value = mode
  selectedTag.value = ''
  searchQuery.value = ''
  
  if (mode === 'favorites') {
    displayedTracks.value = [...favoriteTracks.value]
    return
  }
  
  if (!isJamendoConnected.value) return

  loading.value = true
  
  try {
    let results = []
    
    switch (mode) {
      case 'popular':
        if (getPopularTracks && typeof getPopularTracks === 'function') {
          results = await getPopularTracks({ limit: 30 })
        }
        break
      case 'latest':
        if (getLatestTracks && typeof getLatestTracks === 'function') {
          results = await getLatestTracks({ limit: 30 })
        }
        break
      case 'random':
        if (getRandomTracks && typeof getRandomTracks === 'function') {
          results = await getRandomTracks({ limit: 30 })
        }
        break
    }
    
    displayedTracks.value = results
  } catch (error) {
    console.error('ËºâÂÖ•Â§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∏
const formatTime = (seconds) => {
  if (!seconds || isNaN(seconds)) return '00:00'
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}

// Ë®àÁÆóÂ±¨ÊÄß
const progressPercentage = computed(() => {
  return duration.value ? (currentTime.value / duration.value) * 100 : 0
})

// ËºâÂÖ•ÂèØÁî®Ê®ôÁ±§
const loadAvailableTags = async () => {
  try {
    if (getAvailableTags && typeof getAvailableTags === 'function') {
      const tags = await getAvailableTags()
      if (tags.length > 0) {
        jamendoTags.value = tags
        console.log('‚úÖ Â∑≤ËºâÂÖ• Jamendo ÂÆòÊñπÊõ≤È¢®Ê®ôÁ±§:', tags)
      }
    }
  } catch (error) {
    console.warn('ËºâÂÖ•Ê®ôÁ±§Â§±ÊïóÔºå‰ΩøÁî®ÈªòË™çÊ®ôÁ±§:', error)
  }
}

// Áõ£ËÅΩÊí≠ÊîæÁãÄÊÖãËÆäÂåñ - ÊéßÂà∂ÂùáË°°Âô®
watch(isPlaying, (playing) => {
  if (playing) {
    startEqualizerAnimation()
  } else {
    stopEqualizerAnimation()
  }
}, { immediate: true })

// üÜï Êñ∞Â¢ûÔºöÁõ£ËÅΩÊí≠ÊîæÁ¥¢ÂºïËÆäÂåñ - Êõ¥Êñ∞Ëá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖã
watch(currentTrackIndex, () => {
  if (customPlaylistStatus.value.isActive) {
    updateCustomPlaylistStatus()
  }
}, { immediate: false })

// üÜï Êñ∞Â¢ûÔºöÁõ£ËÅΩÊ®°ÂºèËÆäÂåñ - ÈáçÁΩÆËá™ÂÆöÁæ©Êí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖã
watch(currentMode, (newMode) => {
  if (newMode !== 'custom') {
    customPlaylistStatus.value.isActive = false
  }
}, { immediate: false })

// Áõ£ËÅΩ Jamendo ÈÄ£Êé•ÁãÄÊÖã
watch(isJamendoConnected, async (connected) => {
  if (connected) {
    await loadAvailableTags()
    if (currentMode.value !== 'favorites') {
      await setCurrentMode('popular')
    }
  }
}, { immediate: false })

// ÂàùÂßãÂåñ
onMounted(async () => {
  loadFavoritesFromStorage()
  
  if (isJamendoConnected.value && currentMode.value !== 'favorites') {
    await setCurrentMode('popular')
  }
  
  setTimeout(() => {
    if (isPlaying.value) {
      startEqualizerAnimation()
    }
  }, 500)
  
  // üÜï Êñ∞Â¢ûÔºöÊ∑ªÂä†ÂÖ®Â±ÄÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®‰æÜÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
  document.addEventListener('click', (event) => {
    const target = event.target
    const isDropdownButton = target.closest('.genre-selector-btn') || target.closest('.count-selector-btn')
    
    if (!isDropdownButton) {
      closeAllDropdowns()
    }
  })
})

// Ê∏ÖÁêÜË≥áÊ∫ê
onUnmounted(() => {
  if (searchTimeout) {
    clearTimeout(searchTimeout)
  }
  
  if (equalizerInterval) {
    clearInterval(equalizerInterval)
  }
  
  // üÜï Êñ∞Â¢ûÔºöÁßªÈô§ÂÖ®Â±Ä‰∫ã‰ª∂Áõ£ËÅΩÂô®
  document.removeEventListener('click', closeAllDropdowns)
})
</script>

<style scoped>
/* ÊîπÈÄ≤ÁöÑÈü≥È†ªÂùáË°°Âô®Ë¶ñË¶∫ÊïàÊûú */
.audio-visualizer {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 220px;
  height: 50px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.equalizer-bars {
  display: flex;
  align-items: end;
  justify-content: space-between;
  width: 100%;
  height: 40px;
  gap: 2px;
}

.equalizer-bar {
  width: 10px;
  min-height: 4px;
  height: 8%;
  background: linear-gradient(to top, #666, #999);
  border-radius: 3px;
  transition: height 0.08s ease-out, background 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
  position: relative;
}

/* ‰ΩéÈü≥Ê¢ùÔºà0-4Ôºâ*/
.equalizer-bar[data-freq-group="bass"] {
  background: linear-gradient(to top, #ff6b35 0%, #ff8c42 50%, #ffa449 100%);
}

/* ‰∏≠Èü≥Ê¢ùÔºà5-10Ôºâ*/
.equalizer-bar[data-freq-group="mid"] {
  background: linear-gradient(to top, #f7931e 0%, #ffab00 50%, #ffc107 100%);
}

/* È´òÈü≥Ê¢ùÔºà11-15Ôºâ*/
.equalizer-bar[data-freq-group="high"] {
  background: linear-gradient(to top, #ffcc02 0%, #ffeb3b 50%, #fff200 100%);
}

/* Êí≠ÊîæÊéßÂà∂ÊåâÈàï */
.play-controls-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 0 1rem;
}

/* Êí•ÊîæÊéßÂà∂ÊåâÈàï */
.control-button {
  border-radius: 50%;
  width: 55px;
  height: 55px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: white;
  color: #1f2937;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  background-color: #ffffff;
}

.control-button:hover:not(:disabled) {
  background-color: #f9bc66;
}

/* Êõ≤È¢®ÊåâÈàïÊ®£Âºè */
.genre-btn-new {
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.genre-btn-new:hover {
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px) scale(1.05);
}

/* Êú™ÈÅ∏‰∏≠ÁãÄÊÖãÔºöÁôΩËâ≤ËÉåÊôØÔºåÈªëËâ≤ÊñáÂ≠ó */
.genre-btn-new.bg-white {
  background-color: white;
  color: black;
}

.genre-btn-new.bg-white:hover {
  background-color: #dba8c1;
}

/* ÈÅ∏‰∏≠ÁãÄÊÖãÔºöÁ≤âÁ¥ÖËâ≤ËÉåÊôØÔºåÁôΩËâ≤ÊñáÂ≠ó */
.genre-btn-new.bg-pink-500 {
  background-color: #ec4899;
  color: white;
}

.genre-btn-new.bg-pink-500:hover {
  background-color: #db2777;
}

/* Êî∂ËóèÊåâÈàï */
.heart-outline {
  color: #a2a3a3 !important;
}

.heart-outline:hover {
  color: #ff00f7 !important;
}

.heart-filled {
  color: #ec4899 !important;
  filter: drop-shadow(0 0 4px rgba(236, 72, 153, 0.3));
}

/* üÜï Êñ∞Â¢ûÔºöÊµÆÂãïÂºè‰∏ãÊãâÈÅ∏ÂñÆÊ®£Âºè */
.floating-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: rgba(237, 244, 176, 0.542);
  border: 1px solid #1f4288;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(14, 14, 14, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  z-index: 9999; /* üîß Á¢∫‰øùÊµÆÂãïÂú®ÊúÄ‰∏äÂ±§ */
  min-width: 120px;
  max-height: 200px;
  overflow-y: auto;
  backdrop-filter: blur(8px);
  animation: dropdownFadeIn 0.15s ease-out;
}

/* ‰∏ãÊãâÂÖßÁöÑÊñáÂ≠ó */
.dropdown-item {
  padding: 8px 16px;
  cursor: pointer;
  color: #000000;
  font-weight: 500;
  transition: all 0.15s ease;
  border-bottom: 1px solid #f3f4f6;
}

.dropdown-item:hover {
  background-color: #f3f4f6;
  color: #1f2937;
}

.dropdown-item:first-child {
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
}

.dropdown-item:last-child {
  border-bottom-left-radius: 7px;
  border-bottom-right-radius: 7px;
  border-bottom: none;
}

/* ‰∏ãÊãâÈÅ∏ÂñÆÂãïÁï´ */
@keyframes dropdownFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Ê∑∑ÂíåÊõ≤È¢®Êí≠ÊîæÊ∏ÖÂñÆ */
.custom-playlist-status {
  min-width: 160px;
  max-width: 200px;
  border: 1px solid rgba(255, 252, 252, 0.3);
  backdrop-filter: blur(5px);
}

.custom-playlist-status:hover {
  background: rgba(50, 65, 106, 0.6);
  border-color: rgba(255, 255, 254, 0.5);
}

/* ÊîπÈÄ≤Èü≥È†ªÂùáË°°Âô®Ê®£Âºè */
.audio-visualizer {
  transition: opacity 0.3s ease;
}

/* üîß Á¢∫‰øùÁõ∏Â∞çÂÆö‰ΩçÂÆπÂô®Ê≠£Á¢∫Ë®≠ÁΩÆ */
.relative {
  position: relative;
}

/* ÈüøÊáâÂºèË®≠Ë®à */
@media (max-width: 1280px) {
  .grid-cols-6 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

@media (max-width: 1024px) {
  .grid-cols-6 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  
  .custom-playlist-status {
    min-width: 150px;
    max-width: 200px;
  }
  
  .custom-playlist-status .text-sm {
    font-size: 0.75rem;
  }
  
  .custom-playlist-status .text-xs {
    font-size: 0.7rem;
  }
  
  .floating-dropdown {
    min-width: 100px;
    max-height: 150px;
  }
  
  .dropdown-item {
    padding: 6px 12px;
    font-size: 0.875rem;
  }
}

@media (max-width: 768px) {
  .grid-cols-6 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  .grid-cols-5 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  
  .w-64 { 
    width: 12rem; 
  }
  
  /* Ê∑∑ÂíåÊõ≤È¢®Êí≠ÊîæÊ∏ÖÂñÆÂú®Â∞èÂ±èÂπï‰∏äÁöÑÈüøÊáâÂºèË™øÊï¥ */
  .flex-wrap {
    flex-wrap: wrap;
  }
  
  .space-x-4 > * + * {
    margin-left: 0.5rem;
  }
  
  .gap-4 {
    gap: 0.5rem;
  }
}
</style>