<template>
  <div class="flex h-screen bg-gray-100">
    <!-- Â∑¶ÂÅ¥ÈÇäÊ¨Ñ -->
    <div class="w-64 sidebar text-white p-4">
      <div class="flex items-center justify-between mb-8">
        <img 
          src="@/assets/images/12.png" 
          alt="DDM360" 
          class="h-auto w-20 "
        />
        <div class="flex space-x-2">
          <button v-if="!isSpotifyConnected && spotifyConfigured" @click="connectSpotify" 
                  class="text-green-400 hover:text-green-300 text-sm">
            <font-awesome-icon :icon="['fab', 'spotify']" class="mr-1" />
            ÈÄ£Êé• Spotify
          </button>
          <button v-else-if="isSpotifyConnected" @click="disconnectSpotify" 
                  class="text-green-400 hover:text-green-300 text-sm">
            <font-awesome-icon :icon="['fab', 'spotify']" class="mr-1" />
            Â∑≤ÈÄ£Êé•
          </button>
          <span v-else class="text-gray-400 text-xs">
            Spotify Êú™ÈÖçÁΩÆ
          </span>
        </div>
      </div>

      <nav class="space-y-4 mb-8">
        <button @click="setCurrentMode('random')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700"
                :class="{ 'bg-gray-700': currentMode === 'random' }">
          <font-awesome-icon icon="random" class="mr-3" />
          Èö®Ê©üÊí≠Êîæ
        </button>
        <button @click="setCurrentMode('latest')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700"
                :class="{ 'bg-gray-700': currentMode === 'latest' }">
          <font-awesome-icon icon="music" class="mr-3" />
          Êñ∞Ê≠å
        </button>
        <button @click="setCurrentMode('trending')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700"
                :class="{ 'bg-gray-700': currentMode === 'trending' }">
          <font-awesome-icon icon="fire" class="mr-3" />
          ÁÜ±ÈñÄÊ≠åÊõ≤
        </button>
        <button @click="setCurrentMode('favorites')" 
                class="flex items-center w-full p-3 rounded-lg hover:bg-gray-700"
                :class="{ 'bg-gray-700': currentMode === 'favorites' }">
          <font-awesome-icon icon="heart" class="mr-3" />
          ÊàëÁöÑÊî∂Ëóè
        </button>
      </nav>

      <!-- Spotify Êí≠ÊîæÂô®ÁãÄÊÖã -->
      <div v-if="isSpotifyConnected" class="mt-auto">
        <div class="bg-green-900 p-3 rounded-lg">
          <div class="flex items-center text-green-300 text-sm">
            <font-awesome-icon :icon="['fab', 'spotify']" class="mr-2" />
            <span>Spotify Â∑≤ÈÄ£Êé•</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
    <div class="flex-1 main-content">
      <!-- È†ÇÈÉ®Êí≠ÊîæÂô® - Êñ∞Â∏ÉÂ±Ä -->
      <div class="bg-gray-800 p-6 text-white">
        <div class="flex items-center justify-between">
          <!-- Â∑¶ÂÅ¥ÔºöÁï∂ÂâçÊí≠ÊîæÊ≠åÊõ≤ -->
          <div class="flex items-center min-w-0 flex-1" v-if="currentTrack.name">
            <!-- ÊîæÂ§ßÁöÑÂ∞ÅÈù¢ -->
            <div class="w-20 h-20 rounded-lg mr-4 overflow-hidden flex-shrink-0">
              <img v-if="currentTrack.album?.images?.[0]?.url" 
                   :src="currentTrack.album.images[0].url" 
                   :alt="currentTrack.name" 
                   class="w-full h-full object-cover" />
              <div v-else class="w-full h-full bg-gradient-to-br from-green-500 to-purple-600 flex items-center justify-center">
                <font-awesome-icon icon="music" class="text-white text-2xl" />
              </div>
            </div>
            <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
            <div class="min-w-0 flex-1">
              <p class="font-medium text-lg truncate" :title="currentTrack.name">{{ currentTrack.name }}</p>
              <p class="text-sm text-gray-300 truncate" :title="currentTrack.artists?.map(a => a.name).join(', ')">
                {{ currentTrack.artists?.map(a => a.name).join(', ') }}
              </p>
              <p class="text-xs text-green-400 truncate" v-if="currentTrack.album?.name" :title="currentTrack.album.name">
                {{ currentTrack.album.name }}
              </p>
            </div>
          </div>

          <!-- Âè≥ÂÅ¥ÔºöÊí≠ÊîæÊéßÂà∂ÂíåÈü≥Èáè -->
          <div class="flex items-center space-x-4 flex-shrink-0">
            <!-- Èü≥È†ªÂùáË°°Âô®Ë¶ñË¶∫ÊïàÊûú - ÁßªÂõûÊí≠ÊîæÊåâÈàïÂ∑¶ÈÇä -->
            <div class="audio-visualizer" v-if="currentTrack.name">
              <div class="equalizer-bars">
                <div 
                  v-for="i in 16" 
                  :key="i" 
                  class="equalizer-bar" 
                  :class="{ 'playing': isPlaying }"
                  :style="{ 
                    animationDelay: `${(i - 1) * 0.1}s`,
                    height: isPlaying ? `${Math.random() * 60 + 20}%` : '20%'
                  }"
                ></div>
              </div>
            </div>
            
            <!-- Êí≠ÊîæÊéßÂà∂ÊåâÈàï -->
            <div class="play-controls-container">
              <button @click="handlePreviousTrack" class="control-button">
                <font-awesome-icon icon="step-backward" class="text-lg" />
              </button>
              <button @click="handleTogglePlay" class="control-button">
                <font-awesome-icon :icon="isPlaying ? 'pause' : 'play'" class="text-lg" />
              </button>
              <button @click="handleNextTrack" class="control-button">
                <font-awesome-icon icon="step-forward" class="text-lg" />
              </button>
            </div>
            
            <!-- ÈÄ≤Â∫¶Ê¢ùÂçÄÂüü -->
            <div class="flex items-center space-x-2" style="min-width: 300px;">
              <span class="text-xs text-gray-300 w-12 text-right">{{ formatTime(currentTime) }}</span>
              <div class="flex-1 bg-gray-600 rounded-full h-2 cursor-pointer relative" @click="handleSeek">
                <div class="progress-bar h-2 rounded-full absolute top-0 left-0" 
                     :style="{ width: progressPercentage + '%' }"></div>
              </div>
              <span class="text-xs text-gray-300 w-6">{{ formatTime(duration) }}</span>
            </div>

            <!-- Êí≠ÊîæÊ®°ÂºèÊéßÂà∂ -->
            <div class="flex items-center space-x-2">
              <button @click="toggleShuffle" class="btn btn-circle bg-transparent text-white hover:bg-gray-700"
                      :class="{ 'text-green-400': isShuffled }">
                <font-awesome-icon icon="random" class="text-lg" />
              </button>
              <button @click="toggleRepeat" class="btn btn-circle bg-transparent text-white hover:bg-gray-700"
                      :class="{ 'text-green-400': repeatMode !== 'off' }">
                <font-awesome-icon :icon="repeatMode === 'track' ? 'redo' : 'repeat'" class="text-lg" />
              </button>
            </div>

            <!-- Èü≥ÈáèÊéßÂà∂ -->
            <div class="flex items-center space-x-2">
              <button class="btn btn-circle bg-transparent text-white hover:bg-gray-700">
                <font-awesome-icon :icon="getVolumeIcon()" class="text-lg" />
              </button>
              <input 
                type="range" 
                min="0" 
                max="100" 
                v-model="volume" 
                @input="handleVolumeChange"
                class="volume-slider w-20 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
              />
              <span class="text-xs text-gray-300 w-8">{{ volume }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ÊêúÂ∞ãÊ¨Ñ -->
      <div class="p-6 pb-0" v-if="isSpotifyConnected">
        <div class="relative inline-block w-full">
          <input v-model="searchQuery" @input="searchTracks" 
                 placeholder="üîéÊêúÂ∞ãÊ≠åÊõ≤„ÄÅËóù‰∫∫ÊàñÂ∞àËºØ..." 
                 class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
        </div>
      </div>

      <!-- Êõ≤È¢®ÊåâÈàï -->
      <div class="p-6">
        <div class="grid grid-cols-5 gap-4 mb-8" v-if="isSpotifyConnected && currentMode !== 'favorites'">
          <button v-for="genre in spotifyGenres.slice(0, 5)" :key="genre" 
                  @click="searchByGenre(genre)"
                  class="genre-btn py-3 px-6 rounded-lg text-black hover:bg-pink-400 transition-all duration-300 transform hover:scale-105 active:animate-bounce"
                  :class="selectedGenre === genre ? 'bg-pink-500' : 'bg-blue-800'">
            {{ genre }}
          </button>
        </div>
        <div class="grid grid-cols-5 gap-4 mb-8" v-if="isSpotifyConnected && currentMode !== 'favorites'">
          <button v-for="genre in spotifyGenres.slice(5, 10)" :key="genre" 
                  @click="searchByGenre(genre)"
                  class="genre-btn py-3 px-6 rounded-lg text-black hover:bg-pink-400 transition-all duration-300 transform hover:scale-105 active:animate-bounce"
                  :class="selectedGenre === genre ? 'bg-pink-500' : 'bg-blue-800'">
            {{ genre }}
          </button>
        </div>

        <!-- ÊàëÁöÑÊî∂ËóèÊ®ôÈ°å -->
        <div v-if="currentMode === 'favorites'" class="mb-6">
          <h2 class="text-2xl font-bold text-gray-800 flex items-center">
            <font-awesome-icon icon="heart" class="mr-2 text-red-500" />
            ÊàëÁöÑÊî∂Ëóè ({{ favoriteTrackIds.size }} È¶ñ)
          </h2>
          <p class="text-gray-600 text-sm mt-1">‰Ω†Êî∂ËóèÁöÑÈü≥Ê®ÇÊ∏ÖÂñÆ</p>
        </div>

        <!-- ËºâÂÖ•‰∏≠ -->
        <div v-if="loading" class="flex justify-center items-center h-32 mb-6">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
          <span class="ml-3 text-lg">ËºâÂÖ•‰∏≠...</span>
        </div>

        <!-- Èü≥Ê®ÇÂç°Áâá -->
        <div class="grid grid-cols-6 gap-4">
          <div v-for="track in displayedTracks" :key="track.id" 
               class="music-card bg-white rounded-lg p-3 shadow-md hover:shadow-lg cursor-pointer border relative"
               :class="{ 'ring-2 ring-green-500': currentTrack.id === track.id }">
            
            <!-- ÊÑõÂøÉÊî∂ËóèÊåâÈàï -->
            <button @click.stop="toggleFavorite(track)" 
                    class="absolute top-2 right-2 z-10 p-2 rounded-full bg-white/90 hover:bg-white transition-all duration-300 hover:scale-110 shadow-sm">
              <font-awesome-icon 
                :icon="isFavorite(track.id) ? ['fas', 'heart'] : ['far', 'heart']"
                class="text-sm transition-all duration-300"
                :class="isFavorite(track.id) ? 'text-pink-500 heart-filled' : 'text-gray-400 hover:text-gray-600 heart-outline'" />
            </button>
            
            <!-- Â∞ÅÈù¢ -->
            <div class="w-full h-24 rounded-lg mb-2 flex items-center justify-center overflow-hidden relative"
                 @click="playTrack(track)">
              <img v-if="track.album?.images?.[0]?.url" 
                   :src="track.album.images[0].url" 
                   :alt="track.name" 
                   class="w-full h-full object-cover" />
              <div v-else class="w-full h-full bg-gradient-to-br from-green-500 to-blue-500 flex items-center justify-center">
                <font-awesome-icon icon="music" class="text-white text-2xl" />
              </div>
              
              <!-- Êí≠ÊîæÊåáÁ§∫Âô® -->
              <div v-if="currentTrack.id === track.id && isPlaying" 
                   class="absolute inset-0 bg-black/30 flex items-center justify-center">
                <div class="bg-green-500 text-white rounded-full p-2 animate-pulse">
                  <font-awesome-icon icon="play" class="text-sm" />
                </div>
              </div>
            </div>
            
            <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
            <div @click="playTrack(track)" class="cursor-pointer">
              <h3 class="font-bold text-sm text-gray-800 truncate mb-1" :title="track.name">
                {{ track.name }}
              </h3>
              <p class="text-xs text-gray-600 truncate mb-1" :title="track.artists?.map(a => a.name).join(', ')">
                {{ track.artists?.map(a => a.name).join(', ') }}
              </p>
              <p class="text-xs text-gray-500 truncate mb-2" v-if="track.album?.name" :title="track.album.name">
                {{ track.album.name }}
              </p>
              
              <!-- Â∫ïÈÉ®‰ø°ÊÅØ -->
              <div class="flex justify-between items-center text-xs">
                <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full">Spotify</span>
                <span class="text-gray-500" v-if="track.duration_ms">
                  {{ formatTime(Math.floor(track.duration_ms / 1000)) }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Êú™ÈÄ£Êé• Spotify ÊèêÁ§∫ -->
          <div v-if="!isSpotifyConnected && spotifyConfigured" class="col-span-6 text-center py-16 text-gray-500">
            <font-awesome-icon :icon="['fab', 'spotify']" class="text-6xl mb-4 text-green-400" />
            <h3 class="text-xl font-medium mb-2">ÈÄ£Êé• Spotify</h3>
            <p class="text-sm mb-4">ÈÄ£Êé•‰Ω†ÁöÑ Spotify Â∏≥Êà∂‰æÜÊí≠ÊîæÈü≥Ê®Ç</p>
            <button @click="connectSpotify" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
              <font-awesome-icon :icon="['fab', 'spotify']" class="mr-2" />
              ÈÄ£Êé• Spotify
            </button>
          </div>

          <!-- Spotify Êú™ÈÖçÁΩÆÊèêÁ§∫ -->
          <div v-else-if="!spotifyConfigured" class="col-span-6 text-center py-16 text-gray-500">
            <font-awesome-icon :icon="['fab', 'spotify']" class="text-6xl mb-4 text-gray-400" />
            <h3 class="text-xl font-medium mb-2">Spotify Êú™ÈÖçÁΩÆ</h3>
            <p class="text-sm mb-4">Ë´ãÂú®Áí∞Â¢ÉËÆäÊï∏‰∏≠Ë®≠ÁΩÆ VITE_SPOTIFY_CLIENT_ID</p>
          </div>
          
          <!-- ÁÑ°Ê≠åÊõ≤ÊèêÁ§∫ -->
          <div v-else-if="!loading && displayedTracks.length === 0" 
               class="col-span-6 text-center py-16 text-gray-500">
            <font-awesome-icon :icon="currentMode === 'favorites' ? 'heart' : 'search'" class="text-6xl mb-4 text-gray-300" />
            <h3 class="text-xl font-medium mb-2">
              {{ currentMode === 'favorites' ? 'ÈÇÑÊ≤íÊúâÊî∂Ëóè' : 'ÊêúÂ∞ãÈü≥Ê®Ç' }}
            </h3>
            <p class="text-sm">
              {{ currentMode === 'favorites' ? 'ÈªûÊìäÊ≠åÊõ≤Âè≥‰∏äËßíÁöÑÊÑõÂøÉ‰æÜÊî∂ËóèÈü≥Ê®Ç' : '‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÊ¨ÑÊàñÈªûÊìäÊõ≤È¢®ÊåâÈàï‰æÜÂ∞ãÊâæÈü≥Ê®Ç' }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import { useSpotify } from './composables/useSpotify'

// Spotify ÁµÑÂêàÂºèÂáΩÊï∏
let spotifyComposable = null

try {
  spotifyComposable = useSpotify()
} catch (error) {
  // ÂâµÂª∫Á©∫ÁöÑÊõø‰ª£Â∞çË±°
  spotifyComposable = {
    isSpotifyConnected: ref(false),
    currentTrack: ref({}),
    isPlaying: ref(false),
    currentTime: ref(0),
    duration: ref(0),
    volume: ref(50),
    isShuffled: ref(false),
    repeatMode: ref('off'),
    spotifyDevices: ref([]),
    connectSpotify: () => {},
    disconnectSpotify: () => {},
    playTrack: () => {},
    togglePlay: () => {},
    previousTrack: () => {},
    nextTrack: () => {},
    seek: () => {},
    setVolume: () => {},
    toggleShuffle: () => {},
    toggleRepeat: () => {},
    searchTracks: () => Promise.resolve([]),
    getRecommendations: () => Promise.resolve([]),
    getUserPlaylists: () => Promise.resolve([]),
    getDevices: () => Promise.resolve([])
  }
}

const {
  isSpotifyConnected,
  currentTrack,
  isPlaying,
  currentTime,
  duration,
  volume,
  isShuffled,
  repeatMode,
  connectSpotify,
  disconnectSpotify,
  playTrack,
  togglePlay,
  previousTrack,
  nextTrack,
  seek,
  setVolume,
  toggleShuffle,
  toggleRepeat,
  searchTracks: spotifySearch,
  getRecommendations,
  getUserPlaylists
} = spotifyComposable

// Á¢∫‰øùÊí≠ÊîæÊéßÂà∂ÂáΩÊï∏ÊúâÊïà
const handlePreviousTrack = () => {
  console.log('ÈªûÊìä‰∏ä‰∏ÄÈ¶ñÊåâÈàï')
  if (previousTrack && typeof previousTrack === 'function') {
    previousTrack()
  } else {
    console.warn('previousTrack ÂáΩÊï∏‰∏çÂèØÁî®')
  }
}

const handleNextTrack = () => {
  console.log('ÈªûÊìä‰∏ã‰∏ÄÈ¶ñÊåâÈàï') 
  if (nextTrack && typeof nextTrack === 'function') {
    nextTrack()
  } else {
    console.warn('nextTrack ÂáΩÊï∏‰∏çÂèØÁî®')
  }
}

const handleTogglePlay = () => {
  console.log('ÈªûÊìäÊí≠Êîæ/Êö´ÂÅúÊåâÈàï')
  if (togglePlay && typeof togglePlay === 'function') {
    togglePlay()
  } else {
    console.warn('togglePlay ÂáΩÊï∏‰∏çÂèØÁî®')
  }
}

// Âü∫Êú¨Êï∏Êìö
const currentMode = ref('trending')
const loading = ref(false)
const searchQuery = ref('')
const displayedTracks = ref([])

// Êî∂ËóèÂäüËÉΩ
const favoriteTrackIds = ref(new Set())
const favoriteTracks = ref([])

// ‰øÆÊîπÔºöËøΩËπ§Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊõ≤È¢®ÊåâÈàï (Âè™ËÉΩÊúâ‰∏ÄÂÄã)
const selectedGenre = ref('')

// Ê™¢Êü• Spotify ÊòØÂê¶Â∑≤ÈÖçÁΩÆ
const spotifyConfigured = computed(() => {
  try {
    return !!import.meta.env.VITE_SPOTIFY_CLIENT_ID
  } catch (error) {
    return false
  }
})

// Spotify Êõ≤È¢®
const spotifyGenres = ref([
  'pop', 'rock', 'hip-hop', 'electronic', 'jazz', 
  'classical', 'country', 'latin', 'r&b', 'folk'
])

// Êî∂ËóèÂäüËÉΩÊñπÊ≥ï
const isFavorite = (trackId) => {
  return favoriteTrackIds.value.has(trackId)
}

const toggleFavorite = (track) => {
  if (favoriteTrackIds.value.has(track.id)) {
    // ÁßªÈô§Êî∂Ëóè
    favoriteTrackIds.value.delete(track.id)
    favoriteTracks.value = favoriteTracks.value.filter(t => t.id !== track.id)
  } else {
    // Ê∑ªÂä†Êî∂Ëóè
    favoriteTrackIds.value.add(track.id)
    favoriteTracks.value.push(track)
  }
  
  // Â¶ÇÊûúÁï∂ÂâçÂú®Êî∂ËóèÈ†ÅÈù¢ÔºåÊõ¥Êñ∞È°ØÁ§∫ÁöÑÊ≠åÊõ≤
  if (currentMode.value === 'favorites') {
    displayedTracks.value = [...favoriteTracks.value]
  }
  
  // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÑ≤
  saveFavoritesToStorage()
}

const saveFavoritesToStorage = () => {
  try {
    localStorage.setItem('favorite_tracks', JSON.stringify(favoriteTracks.value))
    localStorage.setItem('favorite_track_ids', JSON.stringify([...favoriteTrackIds.value]))
  } catch (error) {
    console.error('‰øùÂ≠òÊî∂ËóèÂ§±Êïó:', error)
  }
}

const loadFavoritesFromStorage = () => {
  try {
    const savedTracks = localStorage.getItem('favorite_tracks')
    const savedIds = localStorage.getItem('favorite_track_ids')
    
    if (savedTracks) {
      favoriteTracks.value = JSON.parse(savedTracks)
    }
    
    if (savedIds) {
      favoriteTrackIds.value = new Set(JSON.parse(savedIds))
    }
  } catch (error) {
    console.error('ËºâÂÖ•Êî∂ËóèÂ§±Êïó:', error)
  }
}

// Èü≥ÈáèÊéßÂà∂ÊñπÊ≥ï
const getVolumeIcon = () => {
  if (volume.value === 0) return 'volume-mute'
  if (volume.value < 30) return 'volume-down'
  if (volume.value < 70) return 'volume-down'
  return 'volume-up'
}

const handleVolumeChange = (event) => {
  const newVolume = parseInt(event.target.value)
  if (setVolume && typeof setVolume === 'function') {
    setVolume(newVolume)
  }
}

// ÊêúÂ∞ãÂäüËÉΩ
const searchTracks = async () => {
  if (!searchQuery.value.trim() || !isSpotifyConnected.value) return
  
  loading.value = true
  try {
    if (spotifySearch && typeof spotifySearch === 'function') {
      const results = await spotifySearch(searchQuery.value)
      displayedTracks.value = results.slice(0, 30)
    }
  } catch (error) {
    console.error('ÊêúÂ∞ãÂ§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// ÈÄ≤Â∫¶Ê¢ùÈªûÊìäËôïÁêÜ
const handleSeek = (event) => {
  if (!duration.value || !seek || typeof seek !== 'function') return
  
  const rect = event.currentTarget.getBoundingClientRect()
  const clickX = event.clientX - rect.left
  const progressPercent = clickX / rect.width
  const positionMs = Math.floor(progressPercent * duration.value * 1000)
  
  // Ë™øÁî® Spotify ÁöÑ seek ÂáΩÊï∏
  seek(event)
}

// ÊåâÊõ≤È¢®ÊêúÂ∞ã
const searchByGenre = async (genre) => {
  // Ë®≠ÁΩÆÁï∂ÂâçÈÅ∏‰∏≠ÁöÑÊõ≤È¢® (Âè™Êúâ‰∏ÄÂÄãÊúÉÊòØÊ°ÉÁ¥ÖËâ≤)
  selectedGenre.value = genre
  
  loading.value = true
  try {
    if (spotifySearch && typeof spotifySearch === 'function') {
      const results = await spotifySearch(`genre:${genre}`, 'track')
      displayedTracks.value = results.slice(0, 30)
    }
  } catch (error) {
    console.error('Êõ≤È¢®ÊêúÂ∞ãÂ§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// Ë®≠ÁΩÆÊ®°Âºè
const setCurrentMode = async (mode) => {
  currentMode.value = mode
  
  if (mode === 'favorites') {
    // È°ØÁ§∫Êî∂ËóèÁöÑÊ≠åÊõ≤
    displayedTracks.value = [...favoriteTracks.value]
    return
  }
  
  if (!isSpotifyConnected.value) return

  loading.value = true
  
  try {
    let results = []
    
    switch (mode) {
      case 'trending':
        if (spotifySearch && typeof spotifySearch === 'function') {
          results = await spotifySearch('top hits 2024', 'track')
        }
        break
      case 'latest':
        if (spotifySearch && typeof spotifySearch === 'function') {
          results = await spotifySearch('new releases', 'track')
        }
        break
      case 'random':
        if (getRecommendations && typeof getRecommendations === 'function') {
          results = await getRecommendations()
        }
        break
    }
    
    displayedTracks.value = results.slice(0, 30)
  } catch (error) {
    console.error('ËºâÂÖ•Â§±Êïó:', error)
  } finally {
    loading.value = false
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∏
const formatTime = (seconds) => {
  if (!seconds || isNaN(seconds)) return '00:00'
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}

// Èü≥È†ªÂùáË°°Âô®ÂãïÊÖãÊïàÊûú - ÊîπÈÄ≤ÁâàÔºà16Ê¢ùÁâàÊú¨Ôºâ
const audioFrequencyData = ref(Array(16).fill(0.2)) // üëà ÊîπÁÇ∫16ÂÄãÊï∏ÊìöÈªû
const bassFrequencies = [0, 1, 2, 3, 4] // ‰ΩéÈ†ªÔºà5ÂÄãÔºâ
const midFrequencies = [5, 6, 7, 8, 9, 10] // ‰∏≠È†ªÔºà6ÂÄãÔºâ  
const highFrequencies = [11, 12, 13, 14, 15] // È´òÈ†ªÔºà5ÂÄãÔºâ

// Ê®°Êì¨Èü≥È†ªÈ†ªË≠úÂàÜÊûê
const simulateAudioSpectrum = () => {
  if (!isPlaying.value) return
  
  // Âü∫ÊñºÁï∂ÂâçÊôÇÈñìÂâµÂª∫ÁØÄÊãçÊÑü
  const currentTimeMs = Date.now()
  const beatPeriod = 600 // ÁØÄÊãçÈÄ±Êúü (ÊØ´Áßí)
  const beatPhase = (currentTimeMs % beatPeriod) / beatPeriod
  
  // ÂâµÂª∫ÁØÄÊãçÂº∑Â∫¶ (Ê®°Êì¨ÈºìÈªû)
  const beatIntensity = Math.max(0, Math.sin(beatPhase * Math.PI * 2) * 1.2 + 0.3)
  
  // ÁÇ∫‰∏çÂêåÈ†ªÁéáÁØÑÂúçÁîüÊàê‰∏çÂêåÁöÑÊ®°Âºè
  audioFrequencyData.value = audioFrequencyData.value.map((currentValue, index) => {
    let newValue = currentValue
    
    if (bassFrequencies.includes(index)) {
      // ‰ΩéÈ†ªÔºöËºÉÂº∑ÁöÑÁØÄÊãçÊÑüÔºåËÆäÂåñËºÉÊÖ¢
      const bassRandom = Math.random() * 0.5 + 0.3
      const bassPattern = beatIntensity * (0.7 + Math.sin(currentTimeMs * 0.003 + index) * 0.3)
      newValue = bassRandom * bassPattern
      
    } else if (midFrequencies.includes(index)) {
      // ‰∏≠È†ªÔºö‰∏≠Á≠âËÆäÂåñÔºåÊúâÊóãÂæãÊÑü
      const midRandom = Math.random() * 0.6 + 0.2
      const midPattern = Math.sin(currentTimeMs * 0.005 + index * 0.5) * 0.3 + 0.5
      const rhythmBoost = Math.sin(beatPhase * Math.PI * 4) * 0.2
      newValue = midRandom * midPattern + rhythmBoost
      
    } else if (highFrequencies.includes(index)) {
      // È´òÈ†ªÔºöÂø´ÈÄüËÆäÂåñÔºåËºÉÂ∞ñÈä≥
      const highRandom = Math.random() * 0.8 + 0.15
      const highPattern = Math.sin(currentTimeMs * 0.008 + index * 1.2) * 0.4 + 0.3
      const sparkle = Math.random() > 0.7 ? Math.random() * 0.4 : 0
      newValue = highRandom * highPattern + sparkle
    }
    
    // Âπ≥ÊªëÈÅéÊ∏°ÔºåÈÅøÂÖçÁ™ÅÂÖÄÁöÑË∑≥Ë∫ç
    const smoothing = 0.7
    return currentValue * smoothing + newValue * (1 - smoothing)
  })
  
  updateEqualizerBars()
}

const updateEqualizerBars = () => {
  const bars = document.querySelectorAll('.equalizer-bar')
  bars.forEach((bar, index) => {
    const intensity = audioFrequencyData.value[index]
    const height = Math.max(10, Math.min(100, intensity * 120)) // ÈôêÂà∂Âú® 15% Âà∞ 95% ‰πãÈñì
    
    bar.style.height = `${height}%`
    
    // Ê†πÊìöÂº∑Â∫¶Ë™øÊï¥ÁôºÂÖâÊïàÊûú
    if (intensity > 0.7) {
      const glowIntensity = (intensity - 0.7) / 0.3
      bar.style.boxShadow = `
        0 0 ${glowIntensity * 8}px rgba(255, 0, 255, ${glowIntensity * 0.6}),
        0 0 ${glowIntensity * 15}px rgba(0, 255, 255, ${glowIntensity * 0.3})
      `
    } else if (intensity > 0.5) {
      const midGlow = (intensity - 0.5) / 0.2
      bar.style.boxShadow = `0 0 ${midGlow * 4}px rgba(128, 0, 255, ${midGlow * 0.4})`
    } else {
      bar.style.boxShadow = 'none'
    }
    
    // Ê†πÊìöÈ†ªÁéáÁØÑÂúçË™øÊï¥È°èËâ≤Âº∑Â∫¶
    if (bassFrequencies.includes(index)) {
      // ‰ΩéÈ†ªÂÅèÂêëËóçÁ∂†Ëâ≤
      bar.style.filter = `hue-rotate(${intensity * 30}deg) saturate(${1 + intensity * 0.5})`
    } else if (highFrequencies.includes(index)) {
      // È´òÈ†ªÂÅèÂêëÁ¥´Á¥ÖËâ≤
      bar.style.filter = `hue-rotate(${-intensity * 20}deg) saturate(${1 + intensity * 0.8})`
    } else {
      // ‰∏≠È†ª‰øùÊåÅÂéüËâ≤
      bar.style.filter = `saturate(${1 + intensity * 0.6})`
    }
  })
}

// ÊîπÈÄ≤ÁöÑÂãïÁï´ÊéßÂà∂
let equalizerInterval = null
const startEqualizerAnimation = () => {
  if (equalizerInterval) clearInterval(equalizerInterval)
  // ‰ΩøÁî®Êõ¥Áü≠ÁöÑÈñìÈöî‰æÜÁç≤ÂæóÊõ¥ÊµÅÊö¢ÁöÑÂãïÁï´
  equalizerInterval = setInterval(simulateAudioSpectrum, 80) // ÊØè80msÊõ¥Êñ∞‰∏ÄÊ¨°ÔºåÁ¥Ñ12.5 FPS
}

const stopEqualizerAnimation = () => {
  if (equalizerInterval) {
    clearInterval(equalizerInterval)
    equalizerInterval = null
  }
  
  // Âπ≥ÊªëÂú∞Èôç‰ΩéÂà∞ÈùúÊ≠¢ÁãÄÊÖã
  const fadeOut = () => {
    audioFrequencyData.value = audioFrequencyData.value.map(value => value * 0.9)
    updateEqualizerBars()
    
    if (Math.max(...audioFrequencyData.value) > 0.05) {
      setTimeout(fadeOut, 50)
    } else {
      // ÂÆåÂÖ®ÂÅúÊ≠¢ÊôÇÈáçÁΩÆ
      audioFrequencyData.value.fill(0.15)
      const bars = document.querySelectorAll('.equalizer-bar')
      bars.forEach(bar => {
        bar.style.height = '15%'
        bar.style.boxShadow = 'none'
        bar.style.filter = 'none'
      })
    }
  }
  fadeOut()
}

// Ë®àÁÆóÂ±¨ÊÄß
const progressPercentage = computed(() => {
  return duration.value ? (currentTime.value / duration.value) * 100 : 0
})

// Áõ£ËÅΩÊí≠ÊîæÁãÄÊÖãËÆäÂåñÔºåÊéßÂà∂ÂùáË°°Âô®ÂãïÁï´
watch(isPlaying, (playing) => {
  if (playing) {
    startEqualizerAnimation()
  } else {
    stopEqualizerAnimation()
  }
}, { immediate: true })

// Áõ£ËÅΩ Spotify ÈÄ£Êé•ÁãÄÊÖã
watch(isSpotifyConnected, async (connected) => {
  if (connected && currentMode.value !== 'favorites') {
    await setCurrentMode('trending')
  }
}, { immediate: false })

// ÂàùÂßãÂåñ
onMounted(async () => {
  // ËºâÂÖ•Êî∂Ëóè
  loadFavoritesFromStorage()
  
  if (isSpotifyConnected.value && currentMode.value !== 'favorites') {
    await setCurrentMode('trending')
  }
})

// Ê∏ÖÁêÜË≥áÊ∫ê
onUnmounted(() => {
  if (equalizerInterval) {
    clearInterval(equalizerInterval)
  }
})
</script>

<style scoped>
.sidebar {
  background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
}

.main-content {
  background: linear-gradient(90deg, #002879 0%, #e5e7eb 100%);
}

.progress-bar {
  background: linear-gradient(90deg, #1db954 0%, #1ed760 100%);
  transition: width 0.3s ease;
  position: relative;
  z-index: 1;
}

/* ÈÄ≤Â∫¶Ê¢ùÂÆπÂô® */
.progress-container {
  background-color: #4a5568;
  border-radius: 9999px;
  height: 8px;
  position: relative;
  cursor: pointer;
}

.progress-container:hover .progress-bar {
  background: linear-gradient(90deg, #1ed760 0%, #21e065 100%);
}

.music-card {
  transition: all 0.3s ease;
  position: relative;
}

.music-card:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-circle {
  border-radius: 50%;
  width: 3rem;
  height: 3rem;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Èü≥È†ªÂùáË°°Âô®Ë¶ñË¶∫ÊïàÊûú */
.audio-visualizer {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 220px;        /* üëà Âä†ÂØ¨Âà∞120px */
  height: 50px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.equalizer-bars {
  display: flex;
  align-items: end;
  justify-content: space-between;
  width: 100%;
  height: 40px;
  gap: 2px;
}

.equalizer-bar {
  width: 10px;          /* üëà Âæû4pxÂä†Á≤óÂà∞6px */
  min-height: 4px;
  background: linear-gradient(
    to top,
    #00ffff 0%,    /* ÈùíËóçËâ≤Â∫ïÈÉ® */
    #0080ff 25%,   /* ËóçËâ≤ */
    #8000ff 50%,   /* Á¥´Ëâ≤ */
    #ff00ff 75%,   /* Á≤âÁ¥ÖËâ≤ */
    #ff0080 100%   /* Ê°ÉÁ¥ÖËâ≤È†ÇÈÉ® */
  );
  border-radius: 3px;  /* üëà Â∞çÊáâË™øÊï¥ÂúìËßí */
  transition: height 0.08s ease-out, box-shadow 0.1s ease, filter 0.1s ease;
  animation: none;
  position: relative;
}


/* ÁÇ∫ÊØèÂÄãÊ¢ùË®≠ÁΩÆÂü∫Á§éÊ®£ÂºèÂ∑ÆÁï∞ */
.equalizer-bar:nth-child(1),
.equalizer-bar:nth-child(2),
.equalizer-bar:nth-child(3),
.equalizer-bar:nth-child(4),
.equalizer-bar:nth-child(5) {
  /* ‰ΩéÈ†ªÊ¢ù - ÂÅèËóçÁ∂†Ëâ≤Ë™ø */
  background: linear-gradient(
    to top,
    #00ffff 0%,
    #00c0ff 30%,
    #0080ff 60%,
    #4080ff 100%
  );
}

.equalizer-bar:nth-child(6),
.equalizer-bar:nth-child(7),
.equalizer-bar:nth-child(8),
.equalizer-bar:nth-child(9),
.equalizer-bar:nth-child(10),
.equalizer-bar:nth-child(11) {
  /* ‰∏≠È†ªÊ¢ù - ËóçÁ¥´Ëâ≤Ë™ø */
  background: linear-gradient(
    to top,
    #0080ff 0%,
    #4040ff 25%,
    #8000ff 50%,
    #c000ff 75%,
    #ff00c0 100%
  );
}

.equalizer-bar:nth-child(12),
.equalizer-bar:nth-child(13),
.equalizer-bar:nth-child(14),
.equalizer-bar:nth-child(15),
.equalizer-bar:nth-child(16) {
  /* È´òÈ†ªÊ¢ù - Á¥´Á¥ÖËâ≤Ë™ø */
  background: linear-gradient(
    to top,
    #8000ff 0%,
    #c000ff 25%,
    #ff00ff 50%,
    #ff0080 75%,
    #ff4080 100%
  );
}
.play-controls-container {
  display: flex;
  align-items: center;
  gap: 15px; /* Ë®≠ÁΩÆÊåâÈàï‰πãÈñìÁöÑÈñìË∑ùÁÇ∫ 30px */
}

/* Êñ∞Â¢ûÔºöÁµ±‰∏ÄÁöÑÊéßÂà∂ÊåâÈàïÊ®£Âºè */
.control-button {
  border-radius: 50%;
  width: 48px;      /* 3rem = 48px */
  height: 48px;     /* 3rem = 48px */
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: white;
  color: #1f2937;   /* gray-800 */
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.control-button:hover {
  background-color: #e5e7eb; /* gray-200 */
}

/* Èü≥ÈáèÊªëÊ°øÊ®£Âºè */
.volume-slider {
  background: #4a5568;
  outline: none;
}

.volume-slider::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
}

.volume-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: none;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

.animate-pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Êõ≤È¢®ÊåâÈàïÁâπÊÆäÊ®£Âºè */
.genre-btn {
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: none;
  cursor: pointer;
}

.genre-btn:hover {
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px) scale(1.05);
}

.genre-btn:active {
  animation: bounce 0.3s ease-in-out;
  transform: translateY(2px) scale(0.98);
}

@keyframes bounce {
  0% { transform: translateY(0) scale(1); }
  25% { transform: translateY(-8px) scale(1.02); }
  50% { transform: translateY(-4px) scale(1.01); }
  75% { transform: translateY(-2px) scale(1.005); }
  100% { transform: translateY(0) scale(1); }
}

/* Á©∫ÂøÉÊÑõÂøÉÊïàÊûú */
.heart-outline {
  color: #a2a3a3 !important;
  -webkit-text-stroke: 0 #758094;
  text-stroke: 0 #164392;
}

.heart-outline:hover {
  -webkit-text-stroke: 1.5px #2661d6;
  text-stroke: 1.5px #079125;
}

/* ÂØ¶ÂøÉÊÑõÂøÉÊïàÊûú */
.heart-filled {
  color: #ec4899 !important;
  -webkit-text-stroke: 0;
  text-stroke: 0;
  filter: drop-shadow(0 0 4px rgba(236, 72, 153, 0.3));
}

/* ÈüøÊáâÂºèË®≠Ë®à */
@media (max-width: 1280px) {
  .grid-cols-6 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

@media (max-width: 1024px) {
  .grid-cols-6 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

@media (max-width: 768px) {
  .grid-cols-6 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  .grid-cols-5 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  
  .w-64 { 
    width: 12rem; 
  }
  
  /* Âú®Â∞èËû¢Âπï‰∏äÊ∏õÂ∞ëÊåâÈàïÈñìË∑ù */
  .play-controls-container {
    gap: 20px;
  }
  
  .control-button {
    width: 40px;
    height: 40px;
  }
}
</style>